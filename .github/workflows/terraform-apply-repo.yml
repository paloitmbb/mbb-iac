name: Terraform Apply Repository

on:
  pull_request:
    types: [closed]

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  apply-repository:
    name: Apply Repository Configuration
    runs-on: ubuntu-latest
    # Only run if PR was merged and has repo-request label
    if: |
      github.event.pull_request.merged == true &&
      contains(github.event.pull_request.labels.*.name, 'repo-request')

    environment:
      name: repo-creation-approval
      url: https://github.com/${{ github.repository }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: main
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract issue number from PR
        id: extract-issue
        uses: actions/github-script@v7
        with:
          script: |
            const prBody = context.payload.pull_request.body || '';
            const match = prBody.match(/Closes #(\d+)/i);

            if (!match) {
              core.setFailed('Could not find linked issue number in PR body');
              return;
            }

            const issueNumber = match[1];
            core.setOutput('issue-number', issueNumber);

            console.log(`Found linked issue: #${issueNumber}`);
            return issueNumber;

      - name: Extract repository details from PR
        id: extract-details
        uses: actions/github-script@v7
        with:
          script: |
            const prBody = context.payload.pull_request.body || '';

            // Extract repo name from table
            const repoMatch = prBody.match(/\*\*Repository Name\*\*\s*\|\s*`([^`]+)`/);
            const techStackMatch = prBody.match(/\*\*Tech Stack\*\*\s*\|\s*([^\n|]+)/);
            const branchMatch = prBody.match(/\*\*Default Branch\*\*\s*\|\s*`([^`]+)`/);

            if (!repoMatch) {
              core.setFailed('Could not extract repository name from PR body');
              return;
            }

            const repoName = repoMatch[1].trim();
            const techStack = techStackMatch ? techStackMatch[1].trim() : 'Unknown';
            const defaultBranch = branchMatch ? branchMatch[1].trim() : 'main';

            core.setOutput('repo-name', repoName);
            core.setOutput('tech-stack', techStack);
            core.setOutput('default-branch', defaultBranch);

            console.log(`Repository: ${repoName}`);
            console.log(`Tech Stack: ${techStack}`);
            console.log(`Default Branch: ${defaultBranch}`);

            return { repoName, techStack, defaultBranch };

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.5.7

      - name: Terraform Init
        run: |
          ./scripts/init.sh dev
        env:
          GITHUB_TOKEN: ${{ secrets.ORG_GITHUB_TOKEN }}
          TF_HTTP_PASSWORD: ${{ secrets.ORG_GITHUB_TOKEN }}

      - name: Terraform Plan
        id: terraform-plan
        run: |
          terraform plan -var-file=environments/dev/terraform.tfvars -out=tfplan
        env:
          GITHUB_TOKEN: ${{ secrets.ORG_GITHUB_TOKEN }}
          TF_HTTP_PASSWORD: ${{ secrets.ORG_GITHUB_TOKEN }}

      - name: Terraform Apply
        id: terraform-apply
        run: |
          terraform apply -auto-approve tfplan
        env:
          GITHUB_TOKEN: ${{ secrets.ORG_GITHUB_TOKEN }}
          TF_HTTP_PASSWORD: ${{ secrets.ORG_GITHUB_TOKEN }}

      - name: Extract admin users from PR
        id: get-admins
        uses: actions/github-script@v7
        with:
          script: |
            const prBody = context.payload.pull_request.body || '';

            // Extract admin users from PR body table
            const adminMatch = prBody.match(/\*\*Admin Users\*\*\s*\|\s*([^\n|]+)/);

            let adminsList = '';
            if (adminMatch) {
              adminsList = adminMatch[1].trim();
            }

            // If no admins found, use PR author as fallback
            if (!adminsList) {
              adminsList = context.payload.pull_request.user.login;
              core.warning('No admin users found in PR body, using PR author as fallback');
            }

            core.setOutput('maintainers', adminsList);
            console.log(`Admin users: ${adminsList}`);
            return adminsList;

      - name: Assign Team Maintainers
        id: assign-maintainers
        uses: actions/github-script@v7
        with:
          script: |
            const maintainersString = '${{ steps.get-admins.outputs.maintainers }}';
            const maintainerList = maintainersString.split(',').map(u => u.trim()).filter(u => u);

            if (maintainerList.length === 0) {
              core.warning('No maintainers found in teams.yaml');
              return { results: [], success: true };
            }

            const repoName = '${{ steps.extract-details.outputs.repo-name }}';
            const teams = ['dev', 'test', 'prod'];
            const results = [];
            let hasErrors = false;

            for (const teamSuffix of teams) {
              const teamSlug = `${repoName}-${teamSuffix}`;
              
              for (const username of maintainerList) {
                try {
                  await github.rest.teams.addOrUpdateMembershipForUserInOrg({
                    org: context.repo.owner,
                    team_slug: teamSlug,
                    username: username,
                    role: 'maintainer'
                  });
                  results.push(`âœ… Added ${username} as maintainer of ${teamSlug}`);
                } catch (error) {
                  results.push(`âŒ Failed to add ${username} to ${teamSlug}: ${error.message}`);
                  hasErrors = true;
                }
              }
            }

            core.setOutput('results', results.join('\n'));
            core.setOutput('success', !hasErrors);
            core.setOutput('maintainers', maintainerList.join(', '));
            return { results, success: !hasErrors };

      - name: Generate apply summary
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            const repoName = '${{ steps.extract-details.outputs.repo-name }}';
            const org = context.repo.owner;
            const techStack = '${{ steps.extract-details.outputs.tech-stack }}';
            const defaultBranch = '${{ steps.extract-details.outputs.default-branch }}';
            const maintainers = '${{ steps.assign-maintainers.outputs.results }}';
            const issueNumber = '${{ steps.extract-issue.outputs.issue-number }}';
            const prNumber = context.payload.pull_request.number;

            let summary = '# âœ… Repository Created Successfully!\n\n';
            summary += `## ğŸ‰ Repository Details\n\n`;
            summary += '| Field | Value |\n';
            summary += '|-------|-------|\n';
            summary += `| **Repository** | [\`${org}/${repoName}\`](https://github.com/${org}/${repoName}) |\n`;
            summary += `| **Tech Stack** | ${techStack} |\n`;
            summary += `| **Default Branch** | \`${defaultBranch}\` |\n`;
            summary += `| **Configuration** | Using organizational defaults |\n`;
            summary += `| **Source PR** | [#${prNumber}](${context.payload.pull_request.html_url}) |\n`;
            summary += `| **Source Issue** | [#${issueNumber}](https://github.com/${org}/${context.repo.repo}/issues/${issueNumber}) |\n\n`;

            summary += '## ğŸ‘¥ Teams Created\n\n';
            summary += '| Team | Permission | Link |\n';
            summary += '|------|------------|------|\n';
            summary += `| \`${repoName}-dev\` | push | [View Team](https://github.com/orgs/${org}/teams/${repoName}-dev) |\n`;
            summary += `| \`${repoName}-test\` | push | [View Team](https://github.com/orgs/${org}/teams/${repoName}-test) |\n`;
            summary += `| \`${repoName}-prod\` | maintain | [View Team](https://github.com/orgs/${org}/teams/${repoName}-prod) |\n\n`;

            summary += '## ğŸ‘¤ Team Maintainers\n\n';
            summary += '```\n' + maintainers + '\n```\n\n';

            summary += '## ğŸ“‹ Next Steps\n\n';
            summary += `1. ğŸ”— Visit your repository: https://github.com/${org}/${repoName}\n`;
            summary += `2. ğŸ‘¥ Team maintainers can add members to teams via GitHub UI\n`;
            summary += `3. ğŸ”’ Configure branch protection rules if needed\n`;
            summary += `4. ğŸš€ Start developing!\n\n`;

            summary += '---\n\n';
            summary += `*Terraform applied for PR #${prNumber}, completing issue #${issueNumber}*\n`;

            await core.summary
              .addRaw(summary)
              .write();

      - name: Post success comment to issue
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            const repoName = '${{ steps.extract-details.outputs.repo-name }}';
            const org = context.repo.owner;
            const techStack = '${{ steps.extract-details.outputs.tech-stack }}';
            const defaultBranch = '${{ steps.extract-details.outputs.default-branch }}';
            const prNumber = context.payload.pull_request.number;
            const issueNumber = '${{ steps.extract-issue.outputs.issue-number }}';
            const maintainers = '${{ steps.assign-maintainers.outputs.results }}';

            const commentBody = `## âœ… Repository Created Successfully!

            Your repository has been created and configured with organizational defaults.

            ### ğŸ‰ Repository Details
            - **Repository:** [${org}/${repoName}](https://github.com/${org}/${repoName})
            - **Tech Stack:** ${techStack}
            - **Default Branch:** ${defaultBranch}
            - **Configuration:** Using organizational defaults for visibility, features, and security
            - **Created from PR:** [#${prNumber}](${context.payload.pull_request.html_url})

            ### ğŸ‘¥ Teams Created
            - [\`${repoName}-dev\`](https://github.com/orgs/${org}/teams/${repoName}-dev) - Write access
            - [\`${repoName}-test\`](https://github.com/orgs/${org}/teams/${repoName}-test) - Write access
            - [\`${repoName}-prod\`](https://github.com/orgs/${org}/teams/${repoName}-prod) - Maintain access

            ### ğŸ‘¤ Team Maintainers
            \`\`\`
            ${maintainers}
            \`\`\`

            ### ğŸ“‹ Next Steps
            1. Visit your repository: https://github.com/${org}/${repoName}
            2. Team maintainers can add members to teams via GitHub UI
            3. Configure branch protection rules if needed
            4. Start developing! ğŸš€

            ---
            *Automated by GitHub Actions workflow - Terraform applied successfully*`;

            await github.rest.issues.createComment({
              issue_number: issueNumber,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: commentBody
            });

      - name: Close issue
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = '${{ steps.extract-issue.outputs.issue-number }}';

            // Close issue
            await github.rest.issues.update({
              issue_number: issueNumber,
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'closed',
              state_reason: 'completed'
            });

            // Add completion label
            await github.rest.issues.addLabels({
              issue_number: issueNumber,
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: ['completed']
            });

      - name: Generate failure summary
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const repoName = '${{ steps.extract-details.outputs.repo-name }}';
            const issueNumber = '${{ steps.extract-issue.outputs.issue-number }}';
            const prNumber = context.payload.pull_request.number;

            let summary = '# âŒ Repository Creation Failed\n\n';
            summary += `## ğŸš¨ Error Details\n\n`;
            summary += '| Field | Value |\n';
            summary += '|-------|-------|\n';
            summary += `| **Repository** | \`${repoName}\` |\n`;
            summary += `| **Source PR** | [#${prNumber}](${context.payload.pull_request.html_url}) |\n`;
            summary += `| **Source Issue** | [#${issueNumber}](https://github.com/${context.repo.owner}/${context.repo.repo}/issues/${issueNumber}) |\n\n`;

            summary += '## ğŸ” Troubleshooting\n\n';
            summary += '1. Check the workflow logs for detailed error messages\n';
            summary += '2. Verify GITHUB_TOKEN has sufficient permissions\n';
            summary += '3. Ensure the repository name is not already taken\n';
            summary += '4. Verify team names are valid and not already in use\n';
            summary += '5. Check that the YAML files are properly formatted\n\n';

            summary += '## ğŸ“‹ Next Steps\n\n';
            summary += '1. Review the error logs in this workflow run\n';
            summary += '2. Fix the underlying issue\n';
            summary += '3. Re-run the workflow or manually run `terraform apply`\n\n';

            summary += '---\n\n';
            summary += `*Terraform apply failed for PR #${prNumber}*\n`;

            await core.summary
              .addRaw(summary)
              .write();

      - name: Post failure comment to issue
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const repoName = '${{ steps.extract-details.outputs.repo-name }}';
            const issueNumber = '${{ steps.extract-issue.outputs.issue-number }}';
            const prNumber = context.payload.pull_request.number;
            const runUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;

            const commentBody = `## âŒ Repository Creation Failed

            There was an error creating your repository via Terraform.

            ### ğŸš¨ Details
            - **Repository:** \`${repoName}\`
            - **Source PR:** [#${prNumber}](${context.payload.pull_request.html_url})
            - **Workflow Run:** [View logs](${runUrl})

            ### ğŸ” Troubleshooting
            1. Check the [workflow logs](${runUrl}) for detailed error messages
            2. Verify GITHUB_TOKEN has sufficient permissions
            3. Ensure the repository name is not already taken
            4. Verify team names are valid and not already in use

            ### ğŸ“‹ Next Steps
            1. Review the error logs
            2. Fix the underlying issue in the YAML configuration
            3. Re-run the workflow from the [Actions tab](https://github.com/${context.repo.owner}/${context.repo.repo}/actions)
            4. Or manually run \`terraform apply\` after fixing the issue

            ---
            *Please review and address the errors, then retry the workflow*`;

            await github.rest.issues.createComment({
              issue_number: issueNumber,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: commentBody
            });

      - name: Add failure label to issue
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = '${{ steps.extract-issue.outputs.issue-number }}';

            await github.rest.issues.addLabels({
              issue_number: issueNumber,
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: ['terraform-failed']
            });
