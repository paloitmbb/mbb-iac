name: Terraform Apply Repository

on:
  pull_request:
    types: [closed]

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  apply-repository:
    name: Apply Repository Configuration
    runs-on: ubuntu-latest
    # Only run if PR was merged and has repo-request label
    if: |
      github.event.pull_request.merged == true &&
      contains(github.event.pull_request.labels.*.name, 'repo-request')

    environment:
      name: repo-creation-approval
      url: https://github.com/${{ github.repository }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: main
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract issue number from PR
        id: extract-issue
        uses: actions/github-script@v7
        with:
          script: |
            const prBody = context.payload.pull_request.body || '';
            const match = prBody.match(/Closes #(\d+)/i);

            if (!match) {
              core.setFailed('Could not find linked issue number in PR body');
              return;
            }

            const issueNumber = match[1];
            core.setOutput('issue-number', issueNumber);

            console.log(`Found linked issue: #${issueNumber}`);
            return issueNumber;

      - name: Extract repository details from PR
        id: extract-details
        uses: actions/github-script@v7
        with:
          script: |
            const prBody = context.payload.pull_request.body || '';

            // Extract repo name from table
            const repoMatch = prBody.match(/\*\*Repository Name\*\*\s*\|\s*`([^`]+)`/);
            const techStackMatch = prBody.match(/\*\*Tech Stack\*\*\s*\|\s*([^\n|]+)/);
            const branchMatch = prBody.match(/\*\*Default Branch\*\*\s*\|\s*`([^`]+)`/);

            if (!repoMatch) {
              core.setFailed('Could not extract repository name from PR body');
              return;
            }

            const repoName = repoMatch[1].trim();
            const techStack = techStackMatch ? techStackMatch[1].trim() : 'Unknown';
            const defaultBranch = branchMatch ? branchMatch[1].trim() : 'main';

            core.setOutput('repo-name', repoName);
            core.setOutput('tech-stack', techStack);
            core.setOutput('default-branch', defaultBranch);

            console.log(`Repository: ${repoName}`);
            console.log(`Tech Stack: ${techStack}`);
            console.log(`Default Branch: ${defaultBranch}`);

            return { repoName, techStack, defaultBranch };

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.5.7

      - name: Terraform Init
        run: |
          ./scripts/init.sh dev
        env:
          GITHUB_TOKEN: ${{ secrets.ORG_GITHUB_TOKEN }}
          TF_HTTP_PASSWORD: ${{ secrets.ORG_GITHUB_TOKEN }}

      - name: Terraform Plan
        id: terraform-plan
        run: |
          terraform plan -var-file=environments/dev/terraform.tfvars -out=tfplan
        env:
          GITHUB_TOKEN: ${{ secrets.ORG_GITHUB_TOKEN }}
          TF_HTTP_PASSWORD: ${{ secrets.ORG_GITHUB_TOKEN }}

      - name: Terraform Apply
        id: terraform-apply
        run: |
          # Run terraform apply and capture exit code, suppress wrapper output to prevent annotations
          terraform apply -auto-approve tfplan 2>&1 || APPLY_EXIT_CODE=$?
          APPLY_EXIT_CODE=${APPLY_EXIT_CODE:-0}

          if [ $APPLY_EXIT_CODE -ne 0 ]; then
            if [ -f "errored.tfstate" ]; then
              echo "‚ö†Ô∏è  Error saving state detected. Attempting manual state upload..."
              if gh release upload state-dev errored.tfstate --clobber && \
                 gh release download state-dev -p "errored.tfstate" -O terraform.tfstate && \
                 gh release upload state-dev terraform.tfstate --clobber && \
                 rm terraform.tfstate errored.tfstate; then
                echo "‚úÖ State manually uploaded to GitHub release - recovery successful"
                exit 0
              else
                echo "‚ùå State recovery failed"
                exit 1
              fi
            else
              echo "‚ùå Terraform apply failed without state error"
              exit 1
            fi
          fi
          echo "‚úÖ Terraform apply completed successfully"
        env:
          GITHUB_TOKEN: ${{ secrets.ORG_GITHUB_TOKEN }}
          TF_HTTP_PASSWORD: ${{ secrets.ORG_GITHUB_TOKEN }}

      - name: Extract teams from PR
        id: get-teams
        uses: actions/github-script@v7
        with:
          script: |
            const prBody = context.payload.pull_request.body || '';

            // Extract teams from PR body table
            const teamsMatch = prBody.match(/\*\*Teams with Access\*\*\s*\|\s*([^\n|]+)/);

            let teamsList = '';
            let teamsArray = [];

            if (teamsMatch) {
              teamsList = teamsMatch[1].trim();
              // Parse comma-separated teams
              teamsArray = teamsList.split(',').map(t => t.trim()).filter(t => t && t !== 'None');
            }

            core.setOutput('teams', teamsList);
            core.setOutput('teams-array', JSON.stringify(teamsArray));
            console.log(`Teams with access: ${teamsList || 'None'}`);
            return { teams: teamsList, teamsArray };

      - name: Validate Team Access
        id: validate-teams
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.ORG_GITHUB_TOKEN }}
          script: |
            const teamsString = '${{ steps.get-teams.outputs.teams }}';
            const teamsArray = JSON.parse('${{ steps.get-teams.outputs.teams-array }}');

            if (teamsArray.length === 0) {
              console.log('‚ÑπÔ∏è  No teams specified - repository created without team access');
              core.setOutput('summary', 'No teams specified - repository created without team access');
              core.setOutput('success', true);
              return { summary: 'No teams specified', success: true };
            }

            const repoName = '${{ steps.extract-details.outputs.repo-name }}';
            const results = [];
            let hasErrors = false;

            console.log(`\nüîç Verifying team access for repository: ${repoName}`);
            console.log(`üìã Teams: ${teamsArray.join(', ')}\n`);

            for (const teamSlug of teamsArray) {
              try {
                // Verify team exists
                await github.rest.teams.getByName({
                  org: context.repo.owner,
                  team_slug: teamSlug
                });
                
                // Check if team has access to repository
                try {
                  const repoAccess = await github.rest.teams.checkPermissionsForRepoInOrg({
                    org: context.repo.owner,
                    team_slug: teamSlug,
                    owner: context.repo.owner,
                    repo: repoName
                  });
                  
                  results.push('‚úÖ Team `' + teamSlug + '` has `' + repoAccess.data.permission + '` access');
                } catch (error) {
                  // Team exists but doesn't have access - grant it now
                  try {
                    await github.rest.teams.addOrUpdateRepoPermissionsInOrg({
                      org: context.repo.owner,
                      team_slug: teamSlug,
                      owner: context.repo.owner,
                      repo: repoName,
                      permission: 'push' // Default to push (write) access
                    });
                    results.push('‚úÖ Team `' + teamSlug + '` access granted (push permission)');
                  } catch (grantError) {
                    results.push('‚ùå Failed to grant access to team `' + teamSlug + '`: ' + grantError.message);
                    hasErrors = true;
                  }
                }
              } catch (error) {
                results.push('‚ùå Team `' + teamSlug + '` not found or not accessible');
                hasErrors = true;
              }
            }

            const summary = results.join('\n');
            core.setOutput('summary', summary);
            core.setOutput('success', !hasErrors);
            return { summary, success: !hasErrors };

      - name: Generate apply summary
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            const repoName = '${{ steps.extract-details.outputs.repo-name }}';
            const org = context.repo.owner;
            const techStack = '${{ steps.extract-details.outputs.tech-stack }}';
            const defaultBranch = '${{ steps.extract-details.outputs.default-branch }}';
            const teamsString = '${{ steps.get-teams.outputs.teams }}';
            const teamsSummary = '${{ steps.validate-teams.outputs.summary }}';
            const issueNumber = '${{ steps.extract-issue.outputs.issue-number }}';
            const prNumber = context.payload.pull_request.number;

            let summary = '# ‚úÖ Repository Created Successfully!\n\n';
            summary += `## üéâ Repository Details\n\n`;
            summary += '| Field | Value |\n';
            summary += '|-------|-------|\n';
            summary += `| **Repository** | [\\\`${org}/${repoName}\\\`](https://github.com/${org}/${repoName}) |\n`;
            summary += `| **Tech Stack** | ${techStack} |\n`;
            summary += `| **Default Branch** | \\\`${defaultBranch}\\\` |\n`;
            summary += `| **Configuration** | Using organizational defaults |\n`;
            summary += `| **Source PR** | [#${prNumber}](${context.payload.pull_request.html_url}) |\n`;
            summary += `| **Source Issue** | [#${issueNumber}](https://github.com/${org}/${context.repo.repo}/issues/${issueNumber}) |\n\n`;

            if (teamsString && teamsString !== 'None') {
              summary += '## üë• Team Access\n\n';
              summary += teamsSummary + '\n\n';
            } else {
              summary += '## üë• Team Access\n\n';
              summary += 'No teams specified - repository created without team access\n\n';
            }

            summary += '## üìã Next Steps\n\n';
            summary += `1. üîó Visit your repository: https://github.com/${org}/${repoName}\n`;
            summary += `2. üîí Configure branch protection rules if needed\n`;
            summary += `3. üöÄ Start developing!\n\n`;

            summary += '---\n\n';
            summary += `*Terraform applied for PR #${prNumber}, completing issue #${issueNumber}*\n`;

            await core.summary
              .addRaw(summary)
              .write();

      - name: Post success comment to issue
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            const repoName = '${{ steps.extract-details.outputs.repo-name }}';
            const org = context.repo.owner;
            const techStack = '${{ steps.extract-details.outputs.tech-stack }}';
            const defaultBranch = '${{ steps.extract-details.outputs.default-branch }}';
            const prNumber = context.payload.pull_request.number;
            const issueNumber = '${{ steps.extract-issue.outputs.issue-number }}';
            const teamsString = '${{ steps.get-teams.outputs.teams }}';
            const teamsSummary = '${{ steps.validate-teams.outputs.summary }}';

            let teamsSection = '';
            if (teamsString && teamsString !== 'None') {
              teamsSection = `\n\n            ### üë• Team Access\n            ${teamsSummary}`;
            } else {
              teamsSection = `\n\n            ### üë• Team Access\n            No teams specified - repository created without team access`;
            }

            const commentBody = `## ‚úÖ Repository Created Successfully!

            Your repository has been created and configured with organizational defaults.

            ### üéâ Repository Details
            - **Repository:** [${org}/${repoName}](https://github.com/${org}/${repoName})
            - **Tech Stack:** ${techStack}
            - **Default Branch:** ${defaultBranch}
            - **Configuration:** Using organizational defaults for visibility, features, and security
            - **Created from PR:** [#${prNumber}](${context.payload.pull_request.html_url})${teamsSection}

            ### üìã Next Steps
            1. Visit your repository: https://github.com/${org}/${repoName}
            2. Configure branch protection rules if needed
            3. Start developing! üöÄ

            ---
            *Automated by GitHub Actions workflow - Terraform applied successfully*`;

            await github.rest.issues.createComment({
              issue_number: issueNumber,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: commentBody
            });

      - name: Close issue
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = '${{ steps.extract-issue.outputs.issue-number }}';

            // Close issue
            await github.rest.issues.update({
              issue_number: issueNumber,
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'closed',
              state_reason: 'completed'
            });

            // Add completion label
            await github.rest.issues.addLabels({
              issue_number: issueNumber,
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: ['completed']
            });

      - name: Generate failure summary
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const repoName = '${{ steps.extract-details.outputs.repo-name }}';
            const issueNumber = '${{ steps.extract-issue.outputs.issue-number }}';
            const prNumber = context.payload.pull_request.number;

            let summary = '# ‚ùå Repository Creation Failed\n\n';
            summary += `## üö® Error Details\n\n`;
            summary += '| Field | Value |\n';
            summary += '|-------|-------|\n';
            summary += `| **Repository** | \`${repoName}\` |\n`;
            summary += `| **Source PR** | [#${prNumber}](${context.payload.pull_request.html_url}) |\n`;
            summary += `| **Source Issue** | [#${issueNumber}](https://github.com/${context.repo.owner}/${context.repo.repo}/issues/${issueNumber}) |\n\n`;

            summary += '## üîç Troubleshooting\n\n';
            summary += '1. Check the workflow logs for detailed error messages\n';
            summary += '2. Verify GITHUB_TOKEN has sufficient permissions\n';
            summary += '3. Ensure the repository name is not already taken\n';
            summary += '4. Verify team names are valid and exist in the organization\n';
            summary += '5. Check that the YAML files are properly formatted\n\n';

            summary += '## üìã Next Steps\n\n';
            summary += '1. Review the error logs in this workflow run\n';
            summary += '2. Fix the underlying issue\n';
            summary += '3. Re-run the workflow or manually run `terraform apply`\n\n';

            summary += '---\n\n';
            summary += `*Terraform apply failed for PR #${prNumber}*\n`;

            await core.summary
              .addRaw(summary)
              .write();

      - name: Post failure comment to issue
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const repoName = '${{ steps.extract-details.outputs.repo-name }}';
            const issueNumber = '${{ steps.extract-issue.outputs.issue-number }}';
            const prNumber = context.payload.pull_request.number;
            const runUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;

            const commentBody = `## ‚ùå Repository Creation Failed

            There was an error creating your repository via Terraform.

            ### üö® Details
            - **Repository:** \`${repoName}\`
            - **Source PR:** [#${prNumber}](${context.payload.pull_request.html_url})
            - **Workflow Run:** [View logs](${runUrl})

            ### üîç Troubleshooting
            1. Check the [workflow logs](${runUrl}) for detailed error messages
            2. Verify GITHUB_TOKEN has sufficient permissions
            3. Ensure the repository name is not already taken
            4. Verify team names are valid and exist in the organization

            ### üìã Next Steps
            1. Review the error logs
            2. Fix the underlying issue in the YAML configuration
            3. Re-run the workflow from the [Actions tab](https://github.com/${context.repo.owner}/${context.repo.repo}/actions)
            4. Or manually run \`terraform apply\` after fixing the issue

            ---
            *Please review and address the errors, then retry the workflow*`;

            await github.rest.issues.createComment({
              issue_number: issueNumber,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: commentBody
            });

      - name: Add failure label to issue
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = '${{ steps.extract-issue.outputs.issue-number }}';

            await github.rest.issues.addLabels({
              issue_number: issueNumber,
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: ['terraform-failed']
            });
