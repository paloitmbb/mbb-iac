name: Automated Repository Creation Workflow

# on:
#   issues:
#     types: [opened]

# permissions:
#   issues: write
#   contents: write
#   pull-requests: write

jobs:
  # ============================================================================
  # Job 1: Validate and Parse Issue
  # ============================================================================
  validate-request:
    name: Validate Repository Request
    runs-on: ubuntu-latest
    if: startsWith(github.event.issue.title, '[REPO REQUEST]')
    outputs:
      repo-name: ${{ steps.parse.outputs.repo-name }}
      tech-stack: ${{ steps.parse.outputs.tech-stack }}
      justification: ${{ steps.parse.outputs.justification }}
      teams: ${{ steps.parse.outputs.teams }}
      teams-validated: ${{ steps.validate-teams.outputs.team-list }}
      teams-display: ${{ steps.validate-teams.outputs.teams-display }}
      default-branch: ${{ steps.parse.outputs.default-branch }}
      defaults: ${{ steps.load-defaults.outputs.defaults }}
      validation-passed: ${{ steps.validate.outputs.passed }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Parse issue body
        id: parse
        uses: actions/github-script@v7
        with:
          script: |
            const issueBody = context.payload.issue.body;

            // Helper function to extract field value
            function extractField(body, fieldLabel) {
              const regex = new RegExp(`### ${fieldLabel}\\s*\\n\\s*([^\\n#]+)`, 'i');
              const match = body.match(regex);
              return match ? match[1].trim() : '';
            }

            // Extract only simplified form fields
            const repoName = extractField(issueBody, 'Repository Name');
            const techStack = extractField(issueBody, 'Tech Stack');
            const techStackOther = extractField(issueBody, 'Other Tech Stack');
            const justification = extractField(issueBody, 'Business Justification');
            const teams = extractField(issueBody, 'Team Access');
            const defaultBranch = extractField(issueBody, 'Default Branch Name');

            // Determine final tech stack
            const finalTechStack = techStack === 'Others (specify below)' ? techStackOther : techStack;

            // Set outputs (only required fields)
            core.setOutput('repo-name', repoName);
            core.setOutput('tech-stack', finalTechStack);
            core.setOutput('justification', justification);
            core.setOutput('teams', teams);
            core.setOutput('default-branch', defaultBranch || 'main');

      - name: Load default values from defaults.yaml
        id: load-defaults
        run: |
          # Install yq if not available
          if ! command -v yq &> /dev/null; then
            wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
            chmod +x /usr/local/bin/yq
          fi

          # Load repository defaults from defaults.yaml
          DEFAULTS=$(yq eval '.repository_defaults' data/defaults.yaml -o json)
          echo "defaults<<EOF" >> $GITHUB_OUTPUT
          echo "$DEFAULTS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Validate repository name
        id: validate-name
        run: |
          REPO_NAME="${{ steps.parse.outputs.repo-name }}"

          # Check if repo name matches pattern (lowercase, hyphens, no spaces)
          if [[ ! "$REPO_NAME" =~ ^[a-z0-9-]+$ ]]; then
            echo "error=Repository name must be lowercase with hyphens only" >> $GITHUB_OUTPUT
            echo "valid=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "valid=true" >> $GITHUB_OUTPUT

      - name: Validate team existence
        id: validate-teams
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.ORG_GITHUB_TOKEN }}
          script: |
            const teamsString = '${{ steps.parse.outputs.teams }}';
            // Filter out empty strings and GitHub's "_No response_" placeholder
            const teamList = teamsString
              .split(',')
              .map(t => t.trim())
              .filter(t => t && t !== '_No response_');

            console.log(`üîç Validating teams in organization: ${context.repo.owner}`);
            console.log(`üìã Teams to validate: ${teamList.length > 0 ? teamList.join(', ') : 'None (team access is optional)'}`);

            if (teamList.length === 0) {
              console.log('‚ÑπÔ∏è  No teams specified - repository will be created without team access');
              core.setOutput('valid', 'true');
              core.setOutput('team-list', JSON.stringify([]));
              core.setOutput('teams-display', 'None');
              return;
            }

            const invalidTeams = [];
            const validTeams = [];

            // Validate each team exists in organization
            for (const teamSlug of teamList) {
              console.log(`Checking team: "${teamSlug}"`);
              try {
                const team = await github.rest.teams.getByName({
                  org: context.repo.owner,
                  team_slug: teamSlug
                });
                validTeams.push(teamSlug);
                console.log(`‚úÖ Team found: ${teamSlug} (ID: ${team.data.id}, Name: ${team.data.name})`);
              } catch (error) {
                console.log(`‚ùå Team not found: ${teamSlug}`);
                console.log(`   Error: ${error.message}`);
                console.log(`   Status: ${error.status || 'N/A'}`);
                invalidTeams.push(teamSlug);
              }
            }

            if (invalidTeams.length > 0) {
              // Try to list available teams to help with debugging
              try {
                console.log(`üìã Fetching list of teams from organization: ${context.repo.owner}`);
                const { data: orgTeams } = await github.rest.teams.list({
                  org: context.repo.owner,
                  per_page: 100
                });
                console.log(`Found ${orgTeams.length} teams in organization`);
                const teamSlugs = orgTeams.map(t => `${t.slug} (${t.name})`).join(', ');
                core.setOutput('error', `Teams do not exist in organization '${context.repo.owner}': ${invalidTeams.join(', ')}. Available teams: ${teamSlugs}`);
              } catch (listError) {
                console.log(`‚ùå Failed to list teams: ${listError.message}`);
                core.setOutput('error', `Teams do not exist in organization '${context.repo.owner}': ${invalidTeams.join(', ')}. Unable to list available teams - check GitHub token has 'read:org' permission.`);
              }
              core.setOutput('valid', 'false');
              return;
            }

            core.setOutput('valid', 'true');
            core.setOutput('team-list', JSON.stringify(validTeams));
            core.setOutput('teams-display', validTeams.join(', '));

      - name: Check repository existence
        id: check-repo
        uses: actions/github-script@v7
        with:
          script: |
            const repoName = '${{ steps.parse.outputs.repo-name }}';
            try {
              await github.rest.repos.get({
                owner: context.repo.owner,
                repo: repoName
              });
              core.setOutput('exists', 'true');
              core.setOutput('error', `Repository ${repoName} already exists`);
            } catch (error) {
              if (error.status === 404) {
                core.setOutput('exists', 'false');
              } else {
                throw error;
              }
            }

      - name: Consolidate validation
        id: validate
        run: |
          NAME_VALID="${{ steps.validate-name.outputs.valid }}"
          TEAMS_VALID="${{ steps.validate-teams.outputs.valid }}"
          REPO_EXISTS="${{ steps.check-repo.outputs.exists }}"

          if [[ "$NAME_VALID" == "true" && "$TEAMS_VALID" == "true" && "$REPO_EXISTS" != "true" ]]; then
            echo "passed=true" >> $GITHUB_OUTPUT
          else
            echo "passed=false" >> $GITHUB_OUTPUT
          fi

      - name: Generate validation summary
        uses: actions/github-script@v7
        with:
          script: |
            const passed = '${{ steps.validate.outputs.passed }}' === 'true';
            const nameValid = '${{ steps.validate-name.outputs.valid }}' === 'true';
            const teamsValid = '${{ steps.validate-teams.outputs.valid }}' === 'true';
            const repoExists = '${{ steps.check-repo.outputs.exists }}' === 'true';

            let summary = '# üîç Repository Request Validation\n\n';

            if (passed) {
              summary += '## ‚úÖ All validations passed!\n\n';
              summary += '| Field | Value |\n';
              summary += '|-------|-------|\n';
              summary += `| **Repository Name** | \`${{ steps.parse.outputs.repo-name }}\` |\n`;
              summary += `| **Tech Stack** | ${{ steps.parse.outputs.tech-stack }} |\n`;
              summary += `| **Teams with Access** | ${{ steps.validate-teams.outputs.teams-display }} |\n`;
              summary += `| **Default Branch** | ${{ steps.parse.outputs.default-branch }} |\n`;
              summary += `| **Business Justification** | ${{ steps.parse.outputs.justification }} |\n\n`;

              summary += '### üë• Teams with Access\n\n';
              summary += '| Team Name | Status |\n';
              summary += '|-----------|--------|\n';
              const teams = '${{ steps.parse.outputs.teams }}'.split(',').map(t => t.trim());
              for (const team of teams) {
                summary += `| \`${team}\` | ‚úÖ Exists in organization |\n`;
              }
              summary += '\n';

              summary += '### ‚öôÔ∏è Default Configuration\n\n';
              summary += '> üìã All other settings (visibility, features, security, topics, variables) will use organizational defaults from `defaults.yaml`\n\n';
              summary += '---\n\n';
              summary += '### ‚è≥ Next Steps\n\n';
              summary += '- Awaiting approval from **DevSecOps team**\n';
              summary += '- Once approved, repository will be created with access granted to specified teams\n';
            } else {
              summary += '## ‚ùå Validation Failed\n\n';
              summary += '### Errors Found:\n\n';

              if (!nameValid) {
                summary += `- ‚ùå **Repository Name:** ${{ steps.validate-name.outputs.error }}\n`;
              }
              if (!teamsValid) {
                summary += `- ‚ùå **Teams:** ${{ steps.validate-teams.outputs.error }}\n`;
              }
              if (repoExists) {
                summary += `- ‚ùå **Repository Already Exists:** ${{ steps.check-repo.outputs.error }}\n`;
              }

              summary += '\n---\n\n';
              summary += '‚ö†Ô∏è **Please fix the above errors and create a new issue.**\n';
            }

            await core.summary
              .addRaw(summary)
              .write();

      - name: Post validation results
        uses: actions/github-script@v7
        with:
          script: |
            const passed = '${{ steps.validate.outputs.passed }}' === 'true';
            const nameValid = '${{ steps.validate-name.outputs.valid }}' === 'true';
            const teamsValid = '${{ steps.validate-teams.outputs.valid }}' === 'true';
            const repoExists = '${{ steps.check-repo.outputs.exists }}' === 'true';

            let commentBody = '## üîç Repository Request Validation\n\n';

            if (passed) {
              commentBody += '‚úÖ **All validations passed!**\n\n';
              commentBody += '### Request Summary\n';
              commentBody += `- **Repository Name:** \`${{ steps.parse.outputs.repo-name }}\`\n`;
              commentBody += `- **Tech Stack:** ${{ steps.parse.outputs.tech-stack }}\n`;
              const teamsText = '${{ steps.validate-teams.outputs.teams-display }}';
              commentBody += `- **Teams with Access:** ${teamsText}\n`;
              commentBody += `- **Default Branch:** ${{ steps.parse.outputs.default-branch }}\n\n`;

              commentBody += '### Teams with Access\n';
              const teams = '${{ steps.parse.outputs.teams }}'.split(',').map(t => t.trim());
              for (const team of teams) {
                commentBody += `- \`${team}\` ‚úÖ (Existing organization team)\n`;
              }
              commentBody += '\n';

              commentBody += '### Default Configuration\n';
              commentBody += 'üìã All other settings (visibility, features, security, topics, variables) will use organizational defaults from the repository template.\n\n';

              commentBody += '---\n\n';
              commentBody += '‚è≥ **Awaiting approval from DevSecOps team...**\n';
              commentBody += 'Once approved, the repository will be created with access granted to the specified teams.';
            } else {
              commentBody += '‚ùå **Validation Failed**\n\n';
              commentBody += '### Errors Found:\n';

              if (!nameValid) {
                commentBody += `- ‚ùå Repository Name: ${{ steps.validate-name.outputs.error }}\n`;
              }
              if (!teamsValid) {
                commentBody += `- ‚ùå Teams: ${{ steps.validate-teams.outputs.error }}\n`;
              }
              if (repoExists) {
                commentBody += `- ‚ùå Repository Already Exists: ${{ steps.check-repo.outputs.error }}\n`;
              }

              commentBody += '\n---\n\n';
              commentBody += '‚ö†Ô∏è **Please fix the above errors and create a new issue.**';
            }

            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: commentBody
            });

            // Add label based on validation
            if (passed) {
              await github.rest.issues.addLabels({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                labels: ['validation-passed']
              });
            } else {
              await github.rest.issues.addLabels({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                labels: ['validation-failed']
              });

              // Close issue if validation failed
              await github.rest.issues.update({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                state: 'closed'
              });
            }

  # ============================================================================
  # Job 2: Create Repository (Requires Approval)
  # ============================================================================
  create-repository:
    name: Create Repository Configuration
    runs-on: ubuntu-latest
    needs: validate-request
    if: needs.validate-request.outputs.validation-passed == 'true'
    environment: repo-creation-approval # Requires approval from paloitmbb-devsecops

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Update repositories.yaml
        id: update-repos
        run: |
          # Install yq if not available
          if ! command -v yq &> /dev/null; then
            sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
            sudo chmod +x /usr/local/bin/yq
          fi

          # Load defaults from defaults.yaml
          DEFAULTS=$(yq eval '.repository_defaults' data/defaults.yaml -o json)

          # Extract default values
          VISIBILITY=$(echo "$DEFAULTS" | jq -r '.visibility')
          HAS_ISSUES=$(echo "$DEFAULTS" | jq -r '.features.has_issues')
          HAS_PROJECTS=$(echo "$DEFAULTS" | jq -r '.features.has_projects')
          HAS_WIKI=$(echo "$DEFAULTS" | jq -r '.features.has_wiki')

          # Security settings
          VULN_ALERTS=$(echo "$DEFAULTS" | jq -r '.security.enable_vulnerability_alerts')
          ADV_SECURITY=$(echo "$DEFAULTS" | jq -r '.security.enable_advanced_security')
          SECRET_SCAN=$(echo "$DEFAULTS" | jq -r '.security.enable_secret_scanning')
          SECRET_PUSH=$(echo "$DEFAULTS" | jq -r '.security.enable_secret_scanning_push_protection')
          DEPENDABOT_ALERTS=$(echo "$DEFAULTS" | jq -r '.security.enable_dependabot_alerts')
          DEPENDABOT_UPDATES=$(echo "$DEFAULTS" | jq -r '.security.enable_dependabot_security_updates')

          # Get topics from default and add tech stack
          DEFAULT_TOPICS=$(echo "$DEFAULTS" | jq -r '.topics | join(", ")')
          TECH_STACK="${{ needs.validate-request.outputs.tech-stack }}"
          TECH_TOPIC=$(echo "$TECH_STACK" | tr '[:upper:]' '[:lower:]' | tr ' ' '-')

          # Build topics array (defaults + tech stack)
          TOPICS_ARRAY="[]"
          if [ -n "$DEFAULT_TOPICS" ]; then
            # Start with default topics
            IFS=',' read -ra TOPIC_ITEMS <<< "$DEFAULT_TOPICS"
            TOPICS_ARRAY="["
            for topic in "${TOPIC_ITEMS[@]}"; do
              topic=$(echo "$topic" | xargs)  # trim whitespace
              TOPICS_ARRAY="${TOPICS_ARRAY}\"${topic}\", "
            done
            # Add tech stack
            TOPICS_ARRAY="${TOPICS_ARRAY}\"${TECH_TOPIC}\"]"
          else
            TOPICS_ARRAY="[\"${TECH_TOPIC}\"]"
          fi

          # Generate description
          REPO_NAME="${{ needs.validate-request.outputs.repo-name }}"
          DESCRIPTION=$(echo "$REPO_NAME" | sed 's/-/ /g' | awk '{for(i=1;i<=NF;i++) $i=toupper(substr($i,1,1)) tolower(substr($i,2));}1')
          DESCRIPTION="${DESCRIPTION} using ${TECH_STACK}"

          # Parse teams from validated JSON array
          TEAMS_JSON='${{ needs.validate-request.outputs.teams-validated }}'

          # Build teams array in YAML format
          TEAMS_YAML=""
          if [ "$TEAMS_JSON" != "null" ] && [ "$TEAMS_JSON" != "[]" ]; then
            # Parse JSON array and build YAML
            TEAM_COUNT=$(echo "$TEAMS_JSON" | jq -r 'length')
            if [ "$TEAM_COUNT" -gt 0 ]; then
              for i in $(seq 0 $((TEAM_COUNT - 1))); do
                team=$(echo "$TEAMS_JSON" | jq -r ".[$i]")
                if [ -n "$team" ] && [ "$team" != "null" ] && [ "$team" != "_No response_" ]; then
                  TEAMS_YAML="${TEAMS_YAML}      - team: ${team}\n"
                  TEAMS_YAML="${TEAMS_YAML}        permission: push\n"
                fi
              done
            fi
          fi

          # Append to repositories.yaml with proper indentation (2 spaces for array items)
          {
            echo ""
            echo "  - name: ${REPO_NAME}"
            echo "    description: \"${DESCRIPTION}\""
            echo "    visibility: ${VISIBILITY}"
            echo "    features:"
            echo "      has_issues: ${HAS_ISSUES}"
            echo "      has_projects: ${HAS_PROJECTS}"
            echo "      has_wiki: ${HAS_WIKI}"
            echo "    default_branch: ${{ needs.validate-request.outputs.default-branch }}"
            echo "    topics: ${TOPICS_ARRAY}"
            echo "    security:"
            echo "      enable_vulnerability_alerts: ${VULN_ALERTS}"
            echo "      enable_advanced_security: ${ADV_SECURITY}"
            echo "      enable_secret_scanning: ${SECRET_SCAN}"
            echo "      enable_secret_scanning_push_protection: ${SECRET_PUSH}"
            echo "      enable_dependabot_alerts: ${DEPENDABOT_ALERTS}"
            echo "      enable_dependabot_security_updates: ${DEPENDABOT_UPDATES}"
            # Add teams if any were specified
            if [ -n "$TEAMS_YAML" ]; then
              echo "    teams:"
              echo -e "$TEAMS_YAML" | sed 's/^/    /'
            fi
          } >> data/repositories.yaml

          echo "Successfully updated repositories.yaml with team access configuration"

      - name: Create branch and commit changes
        id: create-branch
        run: |
          REPO_NAME="${{ needs.validate-request.outputs.repo-name }}"
          BRANCH_NAME="repo-request/${REPO_NAME}"
          TEAMS="${{ needs.validate-request.outputs.teams-display }}"

          # Delete remote branch if it exists (ignore errors)
          git push origin --delete "${BRANCH_NAME}" 2>/dev/null || true

          git checkout -b "${BRANCH_NAME}"
          git add data/repositories.yaml

          # Build commit message with team access info
          COMMIT_MSG="feat: ‚ú® add repository ${REPO_NAME} with team access

          Repository request from issue #${{ github.event.issue.number }}

          - Repository: ${REPO_NAME}
          - Tech Stack: ${{ needs.validate-request.outputs.tech-stack }}
          - Default Branch: ${{ needs.validate-request.outputs.default-branch }}
          - Configuration: Using organizational defaults"

          if [ -n "$TEAMS" ]; then
            COMMIT_MSG="${COMMIT_MSG}
          - Teams with Access: ${TEAMS}"
          fi

          COMMIT_MSG="${COMMIT_MSG}

          Related to #${{ github.event.issue.number }}"

          git commit -m "$COMMIT_MSG"
          git push origin "${BRANCH_NAME}"

          echo "branch=${BRANCH_NAME}" >> $GITHUB_OUTPUT

      - name: Create Pull Request
        id: create-pr
        uses: actions/github-script@v7
        with:
          script: |
            const repoName = '${{ needs.validate-request.outputs.repo-name }}';
            const techStack = '${{ needs.validate-request.outputs.tech-stack }}';
            const defaultBranch = '${{ needs.validate-request.outputs.default-branch }}';
            const branchName = '${{ steps.create-branch.outputs.branch }}';
            const issueNumber = context.issue.number;

            const teams = '${{ needs.validate-request.outputs.teams-display }}';
            const teamsList = teams && teams !== 'None' ? teams : 'None';

            const prBody = `## üéâ New Repository Request

            ### Repository Details

            | Field | Value |
            |-------|-------|
            | **Repository Name** | \`${repoName}\` |
            | **Tech Stack** | ${techStack} |
            | **Default Branch** | \`${defaultBranch}\` |
            | **Teams with Access** | ${teamsList} |
            | **Requested By** | @${context.payload.issue.user.login} |

            ### Team Access

            ${teams && teams !== 'None' ? teams.split(',').map(t => `- \`${t.trim()}\` - Write access (existing organization team)`).join('\n') : '- No teams specified'}

            ### Configuration

            This PR adds the repository definition to:
            - \`data/repositories.yaml\`

            **Default settings** from \`data/defaults.yaml\` will be applied:
            - Visibility: private
            - Features: Issues, Projects (Wiki disabled)
            - Security: Vulnerability alerts, Dependabot enabled
            - Topics: maybank, mbb, ${techStack.toLowerCase().replace(/ /g, '-')}

            ### Next Steps

            1. ‚úÖ Review the YAML changes
            2. ‚úÖ Merge this PR to apply changes
            3. üöÄ Run Terraform to create the repository and grant team access

            ---

            Closes #${issueNumber}`;

            const pr = await github.rest.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `üÜï Add repository: ${repoName}`,
              head: branchName,
              base: 'main',
              body: prBody
            });

            core.setOutput('pr-number', pr.data.number);
            core.setOutput('pr-url', pr.data.html_url);
            return pr.data;

      - name: Add labels to PR
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ steps.create-pr.outputs.pr-number }},
              labels: ['repo-request', 'automated']
            });

      - name: Generate PR creation summary
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            const repoName = '${{ needs.validate-request.outputs.repo-name }}';
            const techStack = '${{ needs.validate-request.outputs.tech-stack }}';
            const defaultBranch = '${{ needs.validate-request.outputs.default-branch }}';
            const teams = '${{ needs.validate-request.outputs.teams-display }}';
            const teamsList = teams && teams !== 'None' ? teams.split(',').map(t => t.trim()) : [];
            const prUrl = '${{ steps.create-pr.outputs.pr-url }}';
            const prNumber = '${{ steps.create-pr.outputs.pr-number }}';

            let summary = '# ‚úÖ Pull Request Created Successfully!\n\n';
            summary += `## üéâ Repository Configuration Ready\n\n`;
            summary += '| Field | Value |\n';
            summary += '|-------|-------|\n';
            summary += `| **Repository Name** | \`${repoName}\` |\n`;
            summary += `| **Tech Stack** | ${techStack} |\n`;
            summary += `| **Default Branch** | \`${defaultBranch}\` |\n`;
            summary += `| **Teams with Access** | ${teamsList.join(', ') || 'None'} |\n`;
            summary += `| **Pull Request** | [#${prNumber}](${prUrl}) |\n\n`;

            if (teamsList.length > 0) {
              summary += '## üë• Teams with Access\n\n';
              summary += '| Team | Permission | Status |\n';
              summary += '|------|------------|--------|\n';
              for (const team of teamsList) {
                summary += `| \`${team}\` | push | Existing team |\n`;
              }
              summary += '\n';
            }

            summary += '## üìã Next Steps\n\n';
            summary += `1. üìù Review the PR: [#${prNumber}](${prUrl})\n`;
            summary += `2. ‚úÖ Approve and merge the PR\n`;
            summary += `3. üöÄ Run Terraform apply to create repository and grant team access\n\n`;

            summary += '---\n\n';
            summary += `*PR created for issue #${context.issue.number}*\n`;

            await core.summary
              .addRaw(summary)
              .write();

      - name: Post success comment
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            const repoName = '${{ needs.validate-request.outputs.repo-name }}';
            const prUrl = '${{ steps.create-pr.outputs.pr-url }}';
            const prNumber = '${{ steps.create-pr.outputs.pr-number }}';
            const teams = '${{ needs.validate-request.outputs.teams-display }}';
            const teamsList = teams && teams !== 'None' ? teams.split(',').map(t => t.trim()) : [];

            let commentBody = `## ‚úÖ Pull Request Created!

            A pull request has been created to add your repository configuration.

            ### üéâ Configuration Details
            - **Repository Name:** \`${repoName}\`
            - **Tech Stack:** ${{ needs.validate-request.outputs.tech-stack }}
            - **Default Branch:** ${{ needs.validate-request.outputs.default-branch }}
            - **Pull Request:** [#${prNumber}](${prUrl})

            `;

            if (teamsList.length > 0) {
              commentBody += '### üë• Teams with Access\n';
              for (const team of teamsList) {
                commentBody += `- \`${team}\` - Write access (existing organization team)\n`;
              }
              commentBody += '\n';
            }

            commentBody += `### üìã Next Steps
            1. üìù Review the pull request: [#${prNumber}](${prUrl})
            2. ‚úÖ Approve and merge the PR
            3. üöÄ Run \`terraform apply\` to create the repository and grant team access

            ---
            *Automated by GitHub Actions workflow*`;

            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: commentBody
            });

            // Link issue to PR (will be closed when PR is merged)
            await github.rest.issues.addLabels({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: ['pr-created']
            });

      - name: Generate failure summary
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const repoName = '${{ needs.validate-request.outputs.repo-name }}';

            let summary = '# ‚ùå Repository Creation Failed\n\n';
            summary += `## üö® Error Information\n\n`;
            summary += '| Field | Value |\n';
            summary += '|-------|-------|\n';
            summary += `| **Repository Name** | \`${repoName}\` |\n`;
            summary += `| **Workflow Run** | [View Logs](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}) |\n`;
            summary += `| **Issue** | #${context.issue.number} |\n\n`;

            summary += '## üîß Troubleshooting Steps\n\n';
            summary += '1. üìã Check the workflow logs for detailed error messages\n';
            summary += '2. üîç Verify that all required permissions are in place\n';
            summary += '3. üîÑ Ensure no manual changes conflict with automation\n';
            summary += '4. üë• Contact DevSecOps team for assistance\n\n';

            summary += '---\n\n';
            summary += '> ‚ö†Ô∏è A member of the DevSecOps team will investigate and follow up.\n';

            await core.summary
              .addRaw(summary)
              .write();

      - name: Post failure comment
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const commentBody = `## ‚ùå Repository Creation Failed

            There was an error creating the repository. Please check the workflow logs for details.

            ### Error Details
            - **Workflow Run:** [View Logs](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})
            - **Step Failed:** Check the logs above

            ### üîß Troubleshooting
            A member of the DevSecOps team will investigate and follow up.

            ---
            *Automated by GitHub Actions workflow*`;

            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: commentBody
            });

            // Add failure label
            await github.rest.issues.addLabels({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: ['creation-failed']
            });
