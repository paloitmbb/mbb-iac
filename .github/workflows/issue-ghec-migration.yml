name: "MBB GitHub Enterprise Cloud Migration Workflow"

on:
  issues:
    types: [opened]

# Uses separate PATs for source and target:
# - GH_SOURCE_PAT: PAT with read access to source repository
# - GH_TARGET_PAT: PAT with write access to target organization/user
#
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# [GHES â†’ GHEC] If migrating from GitHub Enterprise Server (GHES),
# add these additional secrets:
#   - GHES_API_URL: GHES API base URL (e.g., https://ghes.yourcompany.com/api/v3)
# and replace GH_SOURCE_PAT with a GHES PAT that has read access.
# Search for "[GHES â†’ GHEC]" in this file to find all lines that need changing.
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

jobs:
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Job 1: Validate migration issue request
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  validate:
    name: "Validate Migration Issue Request"
    if: startsWith(github.event.issue.title, '[GHEC Migration]')
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
    outputs:
      source_organization: ${{ steps.parse.outputs.issueparser_source_organization }}
      source_repo: ${{ steps.parse.outputs.issueparser_source_repo }}
      target_organization: ${{ steps.parse.outputs.issueparser_target_organization }}
      target_repo: ${{ steps.parse.outputs.issueparser_target_repo }}
      target_visibility: ${{ steps.parse.outputs.issueparser_target_visibility }}
      migration_options: ${{ steps.parse.outputs.issueparser_migration_options }}
      admins: ${{ steps.parse.outputs.issueparser_admins }}
      team_mappings: ${{ steps.parse.outputs.issueparser_team_mappings }}
      justification: ${{ steps.parse.outputs.issueparser_justification }}
      issue_number: ${{ github.event.issue.number }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Parse Issue Form
        id: parse
        uses: actions/github-script@v7
        with:
          script: |
            const issueBody = context.payload.issue.body;

            // Helper function to extract input/dropdown field value
            function extractField(body, fieldLabel) {
              const regex = new RegExp(`### ${fieldLabel}\\s*\\n\\s*([^\\n#]+)`, 'i');
              const match = body.match(regex);
              return match ? match[1].trim() : '';
            }

            // Helper function to extract textarea field value
            function extractTextarea(body, fieldLabel) {
              const regex = new RegExp(`### ${fieldLabel}\\s*\\n\\s*([\\s\\S]*?)(?=\\n###|$)`, 'i');
              const match = body.match(regex);
              return match ? match[1].trim() : '';
            }

            // Helper function to extract checked options from checkboxes
            function extractCheckboxes(body, fieldLabel) {
              const regex = new RegExp(`### ${fieldLabel}[\\s\\S]*?(?=\\n###|$)`, 'i');
              const section = body.match(regex);
              if (!section) return [];
              
              const checkedItems = [];
              const lines = section[0].split('\n');
              for (const line of lines) {
                if (line.includes('- [X]') || line.includes('- [x]')) {
                  const label = line.replace(/- \[x\]/i, '').trim();
                  checkedItems.push(label);
                }
              }
              return checkedItems;
            }

            // Extract GHEC migration fields
            const sourceOrg = extractField(issueBody, 'Source Organization');
            const sourceRepo = extractField(issueBody, 'Source Repository Name');
            const targetOrg = extractField(issueBody, 'Target Organization');
            const targetRepo = extractField(issueBody, 'Target Repository Name');
            const targetVisibility = extractField(issueBody, 'Target Visibility');
            const admins = extractField(issueBody, 'Admins');
            const teamMappings = extractTextarea(issueBody, 'Team Access Mappings');
            const justification = extractTextarea(issueBody, 'Justification');
            
            // Extract migration options (checkboxes)
            const migrationOptions = extractCheckboxes(issueBody, 'Migration Options');
            const migrationOptionsStr = migrationOptions.join(', ');

            // Set outputs (matching issueparser format)
            core.setOutput('issueparser_source_organization', sourceOrg);
            core.setOutput('issueparser_source_repo', sourceRepo);
            core.setOutput('issueparser_target_organization', targetOrg);
            core.setOutput('issueparser_target_repo', targetRepo);
            core.setOutput('issueparser_target_visibility', targetVisibility);
            core.setOutput('issueparser_migration_options', migrationOptionsStr);
            core.setOutput('issueparser_admins', admins);
            core.setOutput('issueparser_team_mappings', teamMappings);
            core.setOutput('issueparser_justification', justification);

            // Log parsed values
            core.info('Parsed GHEC Migration Request:');
            core.info(`Source: ${sourceOrg}/${sourceRepo}`);
            core.info(`Target: ${targetOrg}/${targetRepo}`);
            core.info(`Visibility: ${targetVisibility}`);
            core.info(`Migration Options: ${migrationOptionsStr}`);
            core.info(`Admins: ${admins}`);

      - name: Display parsed values
        run: |
          echo "Source Org:          ${{ steps.parse.outputs.issueparser_source_organization }}"
          echo "Source Repo:         ${{ steps.parse.outputs.issueparser_source_repo }}"
          echo "Target Org:          ${{ steps.parse.outputs.issueparser_target_organization }}"
          echo "Target Repo:         ${{ steps.parse.outputs.issueparser_target_repo }}"
          echo "Target Visibility:   ${{ steps.parse.outputs.issueparser_target_visibility }}"
          echo "Migration Options:   ${{ steps.parse.outputs.issueparser_migration_options }}"
          echo "Admins:              ${{ steps.parse.outputs.issueparser_admins }}"

      - name: Validate required fields
        run: |
          ERRORS=""

          if [ -z "${{ steps.parse.outputs.issueparser_source_organization }}" ]; then
            ERRORS="${ERRORS}\n- Source Organization is empty"
          fi
          if [ -z "${{ steps.parse.outputs.issueparser_source_repo }}" ]; then
            ERRORS="${ERRORS}\n- Source Repository name is empty"
          fi
          if [ -z "${{ steps.parse.outputs.issueparser_target_organization }}" ]; then
            ERRORS="${ERRORS}\n- Target Organization is empty"
          fi
          if [ -z "${{ steps.parse.outputs.issueparser_target_repo }}" ]; then
            ERRORS="${ERRORS}\n- Target Repository name is empty"
          fi

          if [ -n "$ERRORS" ]; then
            echo "::error::Validation failed"
            gh issue comment ${{ github.event.issue.number }} \
              --body "âŒ **Validation Failed**

          The following required fields are missing:
          $(echo -e $ERRORS)

          Please close this issue and submit a new request."
            exit 1
          fi

          echo "âœ… All required fields present"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Validate source repository exists on GitHub.com
        run: |
          SRC_ORG="${{ steps.parse.outputs.issueparser_source_organization }}"
          SRC_REPO="${{ steps.parse.outputs.issueparser_source_repo }}"

          echo "Checking source: ${SRC_ORG}/${SRC_REPO} on GitHub.com"

          # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          # [GHES â†’ GHEC] Replace api.github.com with GHES API URL:
          #   GHES_API_URL="${{ secrets.GHES_API_URL }}"
          #   HTTP_CODE=$(curl -s -o /tmp/src_repo.json -w "%{http_code}" \
          #     -H "Authorization: Bearer ${{ secrets.GH_SOURCE_PAT }}" \
          #     -H "Accept: application/vnd.github+json" \
          #     "${GHES_API_URL}/repos/${SRC_ORG}/${SRC_REPO}")
          # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          HTTP_CODE=$(curl -s -o /tmp/src_repo.json -w "%{http_code}" \
            -H "Authorization: Bearer ${{ secrets.GH_SOURCE_PAT }}" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/${SRC_ORG}/${SRC_REPO}")

          if [ "$HTTP_CODE" != "200" ]; then
            gh issue comment ${{ github.event.issue.number }} \
              --body "âŒ **Source Validation Failed**

          Repository \`${SRC_ORG}/${SRC_REPO}\` not found on GitHub.com (HTTP ${HTTP_CODE}).

          Verify:
          - Repository name is correct
          - Organization/username is correct
          - The \`GH_SOURCE_PAT\` secret has read access to the source repo"
            exit 1
          fi

          ARCHIVED=$(jq -r '.archived' /tmp/src_repo.json)
          if [ "$ARCHIVED" = "true" ]; then
            gh issue comment ${{ github.event.issue.number }} \
              --body "âŒ **Source Validation Failed**

          Repository \`${SRC_ORG}/${SRC_REPO}\` is already **archived**. Cannot migrate an archived repository."
            exit 1
          fi

          SIZE=$(jq -r '.size' /tmp/src_repo.json)
          BRANCH=$(jq -r '.default_branch' /tmp/src_repo.json)
          VISIBILITY=$(jq -r '.visibility' /tmp/src_repo.json)

          echo "âœ… Source repository verified"
          echo "   Size: ${SIZE} KB"
          echo "   Default branch: ${BRANCH}"
          echo "   Visibility: ${VISIBILITY}"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Validate target organization exists on GitHub.com
        run: |
          TGT_ORG="${{ steps.parse.outputs.issueparser_target_organization }}"

          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" \
            -H "Authorization: Bearer ${{ secrets.GH_TARGET_PAT }}" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/orgs/${TGT_ORG}")

          # Check if it's a user instead of an org
          if [ "$HTTP_CODE" != "200" ]; then
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" \
              -H "Authorization: Bearer ${{ secrets.GH_TARGET_PAT }}" \
              -H "Accept: application/vnd.github+json" \
              "https://api.github.com/users/${TGT_ORG}")
          fi

          if [ "$HTTP_CODE" != "200" ]; then
            gh issue comment ${{ github.event.issue.number }} \
              --body "âŒ **Target Validation Failed**

          Organization/User \`${TGT_ORG}\` not found on GitHub.com (HTTP ${HTTP_CODE}).

          Ensure the target organization or user exists before requesting migration."
            exit 1
          fi

          echo "âœ… Target organization/user '${TGT_ORG}' verified on GitHub.com"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Check target repo name not taken
        run: |
          TGT_ORG="${{ steps.parse.outputs.issueparser_target_organization }}"
          TGT_REPO="${{ steps.parse.outputs.issueparser_target_repo }}"

          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" \
            -H "Authorization: Bearer ${{ secrets.GH_TARGET_PAT }}" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/${TGT_ORG}/${TGT_REPO}")

          if [ "$HTTP_CODE" = "200" ]; then
            gh issue comment ${{ github.event.issue.number }} \
              --body "âŒ **Target Validation Failed**

          Repository \`${TGT_ORG}/${TGT_REPO}\` **already exists** on GitHub.com.

          Choose a different target repository name or delete the existing one first."
            exit 1
          fi

          echo "âœ… Target name '${TGT_ORG}/${TGT_REPO}' is available"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Post validation results
        uses: actions/github-script@v7
        with:
          script: |
            const sourceOrg = '${{ steps.parse.outputs.issueparser_source_organization }}';
            const sourceRepo = '${{ steps.parse.outputs.issueparser_source_repo }}';
            const targetOrg = '${{ steps.parse.outputs.issueparser_target_organization }}';
            const targetRepo = '${{ steps.parse.outputs.issueparser_target_repo }}';
            const targetVisibility = '${{ steps.parse.outputs.issueparser_target_visibility }}';
            const migrationOptions = '${{ steps.parse.outputs.issueparser_migration_options }}';
            const admins = '${{ steps.parse.outputs.issueparser_admins }}';
            const teamMappings = '${{ steps.parse.outputs.issueparser_team_mappings }}';
            const justification = '${{ steps.parse.outputs.issueparser_justification }}';

            const allValid = sourceOrg && sourceRepo && targetOrg && targetRepo;

            let commentBody = '## ðŸ” GitHub.com â†’ GitHub.com Migration Request Validation\n\n';

            if (allValid) {
              commentBody += 'âœ… **All validations passed!**\n\n';
              commentBody += '### Migration Summary\n';
              commentBody += `- **Source Repository:** \`${sourceOrg}/${sourceRepo}\`\n`;
              commentBody += `- **Target Repository:** \`${targetOrg}/${targetRepo}\`\n`;
              commentBody += `- **Target Visibility:** \`${targetVisibility}\`\n`;
              commentBody += `- **Admins:** ${admins}\n\n`;
              
              if (migrationOptions) {
                commentBody += '### Migration Options\n';
                const options = migrationOptions.split(',').map(opt => opt.trim()).filter(opt => opt);
                if (options.length > 0) {
                  for (const option of options) {
                    commentBody += `- âœ… ${option}\n`;
                  }
                } else {
                  commentBody += '- No additional migration options selected\n';
                }
                commentBody += '\n';
              }

              if (teamMappings && teamMappings.trim()) {
                commentBody += '### ðŸ‘¥ Team Access Mappings\n';
                commentBody += '```\n';
                commentBody += teamMappings + '\n';
                commentBody += '```\n\n';
              }

              if (justification && justification.trim()) {
                commentBody += '### ðŸ“ Justification\n';
                commentBody += '> ' + justification.split('\n').join('\n> ') + '\n\n';
              }
              
              commentBody += '---\n\n';
              commentBody += 'â³ **Migration process will begin shortly...**\n\n';
              commentBody += '**Next Steps:**\n';
              commentBody += '1. ðŸ“Š Pre-migration state recording\n';
              commentBody += '2. ðŸš€ Execute GEI migration\n';
              commentBody += '3. ðŸ”§ Post-migration setup\n';
              commentBody += '4. âœ… Verification checks\n';
              commentBody += '5. ðŸ“¦ Cutover and cleanup\n';
            } else {
              commentBody += 'âŒ **Validation Failed**\n\n';
              commentBody += '### Errors Found:\n';
              
              if (!sourceOrg) {
                commentBody += '- âŒ Source Organization: Missing or empty\n';
              }
              if (!sourceRepo) {
                commentBody += '- âŒ Source Repository: Missing or empty\n';
              }
              if (!targetOrg) {
                commentBody += '- âŒ Target Organization: Missing or empty\n';
              }
              if (!targetRepo) {
                commentBody += '- âŒ Target Repository: Missing or empty\n';
              }
              
              commentBody += '\n---\n\n';
              commentBody += 'âš ï¸ **This issue will be closed. Please fix the errors and create a new migration request.**';
            }

            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: commentBody
            });

            // Add label based on validation
            if (allValid) {
              await github.rest.issues.addLabels({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                labels: ['validation-passed', 'ghec-migration-request']
              });
            } else {
              await github.rest.issues.addLabels({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                labels: ['validation-failed']
              });
              
              // // Close issue if validation failed
              // await github.rest.issues.update({
              //   issue_number: context.issue.number,
              //   owner: context.repo.owner,
              //   repo: context.repo.repo,
              //   state: 'closed',
              //   state_reason: 'not_planned'
              // });
              
              // Exit the workflow
              core.setFailed('Validation failed - issue closed');
            }

      - name: Comment validation passed
        uses: peter-evans/create-or-update-comment@v4
        with:
          issue-number: ${{ github.event.issue.number }}
          body: |
            ### âœ… Validation Passed

            | Field | Value |
            |-------|-------|
            | **Source (GitHub.com)** | `${{ steps.parse.outputs.issueparser_source_organization }}/${{ steps.parse.outputs.issueparser_source_repo }}` |
            | **Target (GitHub.com)** | `${{ steps.parse.outputs.issueparser_target_organization }}/${{ steps.parse.outputs.issueparser_target_repo }}` |
            | **Visibility** | `${{ steps.parse.outputs.issueparser_target_visibility }}` |
            | **Admins** | `${{ steps.parse.outputs.issueparser_admins }}` |

            ðŸš€ Proceeding with migration...

      - name: Generate validation summary
        uses: actions/github-script@v7
        with:
          script: |
            const sourceOrg = '${{ steps.parse.outputs.issueparser_source_organization }}';
            const sourceRepo = '${{ steps.parse.outputs.issueparser_source_repo }}';
            const targetOrg = '${{ steps.parse.outputs.issueparser_target_organization }}';
            const targetRepo = '${{ steps.parse.outputs.issueparser_target_repo }}';
            const targetVisibility = '${{ steps.parse.outputs.issueparser_target_visibility }}';
            const migrationOptions = '${{ steps.parse.outputs.issueparser_migration_options }}';
            const admins = '${{ steps.parse.outputs.issueparser_admins }}';
            const teamMappings = '${{ steps.parse.outputs.issueparser_team_mappings }}';
            const justification = '${{ steps.parse.outputs.issueparser_justification }}';

            const allValid = sourceOrg && sourceRepo && targetOrg && targetRepo;

            let summary = '# ðŸ” GitHub.com â†’ GitHub.com Migration Request Validation\n\n';

            if (allValid) {
              summary += '## âœ… All validations passed!\n\n';
              summary += '### ðŸ“‹ Migration Details\n\n';
              summary += '| Field | Value |\n';
              summary += '|-------|-------|\n';
              summary += `| **Source Repository** | \`${sourceOrg}/${sourceRepo}\` |\n`;
              summary += `| **Target Repository** | \`${targetOrg}/${targetRepo}\` |\n`;
              summary += `| **Target Visibility** | \`${targetVisibility}\` |\n`;
              summary += `| **Admins** | ${admins} |\n`;
              
              if (migrationOptions) {
                summary += '\n### âš™ï¸ Migration Options\n\n';
                const options = migrationOptions.split(',').map(opt => opt.trim()).filter(opt => opt);
                if (options.length > 0) {
                  for (const option of options) {
                    summary += `- âœ… ${option}\n`;
                  }
                } else {
                  summary += '- No additional migration options selected\n';
                }
              }

              if (teamMappings && teamMappings.trim()) {
                summary += '\n### ðŸ‘¥ Team Access Mappings\n\n';
                summary += '```\n';
                summary += teamMappings + '\n';
                summary += '```\n';
              }

              if (justification && justification.trim()) {
                summary += '\n### ðŸ“ Justification\n\n';
                summary += '> ' + justification.split('\n').join('\n> ') + '\n';
              }
              
              summary += '\n---\n\n';
              summary += '### â³ Next Steps\n\n';
              summary += '1. ðŸ“Š Pre-migration state recording\n';
              summary += '2. ðŸš€ Execute GEI migration\n';
              summary += '3. ðŸ”§ Post-migration setup (admins, teams, branch protection)\n';
              summary += '4. âœ… Verification checks\n';
              summary += '5. ðŸ“¦ Cutover and archive (if requested)\n';
            } else {
              summary += '## âŒ Validation Failed\n\n';
              summary += '### Errors Found:\n\n';
              
              if (!sourceOrg) {
                summary += '- âŒ **Source Organization:** Missing or empty\n';
              }
              if (!sourceRepo) {
                summary += '- âŒ **Source Repository:** Missing or empty\n';
              }
              if (!targetOrg) {
                summary += '- âŒ **Target Organization:** Missing or empty\n';
              }
              if (!targetRepo) {
                summary += '- âŒ **Target Repository:** Missing or empty\n';
              }
              
              summary += '\n---\n\n';
              summary += 'âš ï¸ **Please fix the above errors and create a new issue.**\n';
            }

            await core.summary
              .addRaw(summary)
              .write();

      - name: Label as in-progress
        run: |
          gh label create "in-progress" --color "FBCA04" --description "Request is being processed" --force 2>/dev/null || true
          gh issue edit ${{ github.event.issue.number }} --add-label "in-progress"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Migration:
  #   name: Migration Configuration
  #   runs-on: ubuntu-latest
  #   needs: validate
  #   permissions:
  #     contents: write
  #     issues: write
  #     pull-requests: write
  #   environment:
  #     name: "migration-approval" # Requires approval from paloitmbb-devsecops

  #   steps:
  #     - name: Checkout repository
  #       uses: actions/checkout@v4
  #       with:
  #         token: ${{ secrets.GITHUB_TOKEN }}

  #     - name: Configure Git
  #       run: |
  #         git config user.name "github-actions[bot]"
  #         git config user.email "github-actions[bot]@users.noreply.github.com"

  #     - name: Update ghec-migration.yaml
  #       id: update-migration
  #       run: |
  #         # Install yq if not available
  #         if ! command -v yq &> /dev/null; then
  #           sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
  #           sudo chmod +x /usr/local/bin/yq
  #         fi

  #         SOURCE_ORG="${{ needs.validate.outputs.source_organization }}"
  #         SOURCE_REPO="${{ needs.validate.outputs.source_repo }}"
  #         TARGET_ORG="${{ needs.validate.outputs.target_organization }}"
  #         TARGET_REPO="${{ needs.validate.outputs.target_repo }}"
  #         TARGET_VISIBILITY="${{ needs.validate.outputs.target_visibility }}"
  #         ADMINS="${{ needs.validate.outputs.admins }}"
  #         MIGRATION_OPTIONS="${{ needs.validate.outputs.migration_options }}"
  #         TEAM_MAPPINGS="${{ needs.validate.outputs.team_mappings }}"
  #         JUSTIFICATION="${{ needs.validate.outputs.justification }}"
  #         ISSUE_NUMBER="${{ github.event.issue.number }}"
  #         TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

  #         # Parse migration options into flags
  #         ARCHIVE_SOURCE="false"
  #         if echo "$MIGRATION_OPTIONS" | grep -qi "Archive source repository"; then
  #           ARCHIVE_SOURCE="true"
  #         fi

  #         # Parse admins into YAML array format
  #         ADMINS_YAML=""
  #         if [ -n "$ADMINS" ] && [ "$ADMINS" != "_No response_" ]; then
  #           IFS=',' read -ra ADMIN_ITEMS <<< "$ADMINS"
  #           for admin in "${ADMIN_ITEMS[@]}"; do
  #             admin=$(echo "$admin" | xargs | sed 's/^@//')  # trim whitespace and @
  #             if [ -n "$admin" ]; then
  #               ADMINS_YAML="${ADMINS_YAML}      - ${admin}\n"
  #             fi
  #           done
  #         fi

  #         # Parse team mappings into YAML format
  #         TEAMS_YAML=""
  #         if [ -n "$TEAM_MAPPINGS" ] && [ "$TEAM_MAPPINGS" != "_No response_" ]; then
  #           echo "$TEAM_MAPPINGS" | while IFS= read -r LINE; do
  #             LINE=$(echo "$LINE" | xargs)
  #             [ -z "$LINE" ] && continue
  #             [[ "$LINE" == \#* ]] && continue

  #             # Parse: source-team â†’ target-team : permission
  #             if echo "$LINE" | grep -q "â†’"; then
  #               TARGET_PART=$(echo "$LINE" | sed 's/.*â†’//' | xargs)
  #             elif echo "$LINE" | grep -q "->"; then
  #               TARGET_PART=$(echo "$LINE" | sed 's/.*->//' | xargs)
  #             else
  #               continue
  #             fi

  #             if echo "$TARGET_PART" | grep -q ":"; then
  #               TARGET_TEAM=$(echo "$TARGET_PART" | sed 's/:.*//' | xargs)
  #               PERMISSION=$(echo "$TARGET_PART" | sed 's/.*://' | xargs)
  #             else
  #               TARGET_TEAM="$TARGET_PART"
  #               PERMISSION="push"
  #             fi

  #             TEAMS_YAML="${TEAMS_YAML}      - team: ${TARGET_TEAM}\n"
  #             TEAMS_YAML="${TEAMS_YAML}        permission: ${PERMISSION}\n"
  #           done
  #         fi

  #         # Append migration entry to ghec-migration.yaml
  #         {
  #           echo ""
  #           echo "  - source_organization: ${SOURCE_ORG}"
  #           echo "    source_repository: ${SOURCE_REPO}"
  #           echo "    target_organization: ${TARGET_ORG}"
  #           echo "    target_repository: ${TARGET_REPO}"
  #           echo "    target_visibility: ${TARGET_VISIBILITY}"
  #           echo "    migration_options:"
  #           echo "      archive_source: ${ARCHIVE_SOURCE}"
  #           echo "    admins:"
  #           if [ -n "$ADMINS_YAML" ]; then
  #             echo -e "$ADMINS_YAML" | sed '/^$/d'
  #           fi
  #           if [ -n "$TEAMS_YAML" ]; then
  #             echo "    teams:"
  #             echo -e "$TEAMS_YAML" | sed '/^$/d'
  #           fi
  #           echo "    justification: \"${JUSTIFICATION}\""
  #           echo "    issue_number: ${ISSUE_NUMBER}"
  #           echo "    requested_at: ${TIMESTAMP}"
  #           echo "    status: approved"
  #         } >> data/ghec-migration.yaml

  #         echo "âœ… Successfully updated ghec-migration.yaml with migration configuration"

  #     - name: Create branch and commit changes
  #       id: create-branch
  #       run: |
  #         SOURCE_ORG="${{ needs.validate.outputs.source_organization }}"
  #         SOURCE_REPO="${{ needs.validate.outputs.source_repo }}"
  #         TARGET_ORG="${{ needs.validate.outputs.target_organization }}"
  #         TARGET_REPO="${{ needs.validate.outputs.target_repo }}"
  #         ADMINS="${{ needs.validate.outputs.admins }}"
  #         TEAM_MAPPINGS="${{ needs.validate.outputs.team_mappings }}"
  #         BRANCH_NAME="migration-request/${SOURCE_REPO}-to-${TARGET_ORG}"

  #         # Delete remote branch if it exists (ignore errors)
  #         git push origin --delete "${BRANCH_NAME}" 2>/dev/null || true

  #         git checkout -b "${BRANCH_NAME}"
  #         git add data/ghec-migration.yaml

  #         # Build commit message with migration info
  #         COMMIT_MSG="feat: ðŸš€ add GHEC migration config ${SOURCE_ORG}/${SOURCE_REPO} â†’ ${TARGET_ORG}/${TARGET_REPO}

  #         Migration request from issue #${{ github.event.issue.number }}

  #         - Source: ${SOURCE_ORG}/${SOURCE_REPO}
  #         - Target: ${TARGET_ORG}/${TARGET_REPO}
  #         - Visibility: ${{ needs.validate.outputs.target_visibility }}
  #         - Migration Options: ${{ needs.validate.outputs.migration_options }}"

  #         if [ -n "$ADMINS" ] && [ "$ADMINS" != "_No response_" ]; then
  #           COMMIT_MSG="${COMMIT_MSG}
  #         - Admins: ${ADMINS}"
  #         fi

  #         if [ -n "$TEAM_MAPPINGS" ] && [ "$TEAM_MAPPINGS" != "_No response_" ]; then
  #           COMMIT_MSG="${COMMIT_MSG}
  #         - Team Mappings: Configured"
  #         fi

  #         COMMIT_MSG="${COMMIT_MSG}

  #         Related to #${{ github.event.issue.number }}"

  #         git commit -m "$COMMIT_MSG"
  #         git push origin "${BRANCH_NAME}"

  #         echo "branch=${BRANCH_NAME}" >> $GITHUB_OUTPUT

  #     - name: Create Pull Request
  #       id: create-pr
  #       uses: actions/github-script@v7
  #       with:
  #         script: |
  #           const sourceOrg = '${{ needs.validate.outputs.source_organization }}';
  #           const sourceRepo = '${{ needs.validate.outputs.source_repo }}';
  #           const targetOrg = '${{ needs.validate.outputs.target_organization }}';
  #           const targetRepo = '${{ needs.validate.outputs.target_repo }}';
  #           const targetVisibility = '${{ needs.validate.outputs.target_visibility }}';
  #           const migrationOptions = '${{ needs.validate.outputs.migration_options }}';
  #           const admins = '${{ needs.validate.outputs.admins }}';
  #           const teamMappings = '${{ needs.validate.outputs.team_mappings }}';
  #           const justification = '${{ needs.validate.outputs.justification }}';
  #           const branchName = '${{ steps.create-branch.outputs.branch }}';
  #           const issueNumber = context.issue.number;

  #           const adminsList = admins && admins !== '_No response_'
  #             ? admins.split(',').map(a => `\`${a.trim().replace(/^@/, '')}\``).join(', ')
  #             : 'None';

  #           const optionsList = migrationOptions
  #             ? migrationOptions.split(',').map(o => `- âœ… ${o.trim()}`).join('\n')
  #             : '- No additional options selected';

  #           const teamSection = teamMappings && teamMappings !== '_No response_'
  #             ? teamMappings.split('\n').filter(l => l.trim()).map(l => `- \`${l.trim()}\``).join('\n')
  #             : '- No team mappings specified';

  #           const prBody = `## ðŸš€ GHEC Migration Request

  #           ### Migration Details

  #           | Field | Value |
  #           |-------|-------|
  #           | **Source Repository** | \`${sourceOrg}/${sourceRepo}\` |
  #           | **Target Repository** | \`${targetOrg}/${targetRepo}\` |
  #           | **Target Visibility** | \`${targetVisibility}\` |
  #           | **Admins** | ${adminsList} |
  #           | **Requested By** | @${context.payload.issue.user.login} |

  #           ### Migration Options

  #           ${optionsList}

  #           ### Team Access Mappings

  #           ${teamSection}

  #           ### Justification

  #           > ${justification || 'No justification provided'}

  #           ### Configuration

  #           This PR adds the migration entry to:
  #           - \`data/ghec-migration.yaml\`

  #           ### Next Steps

  #           1. âœ… Review the YAML changes
  #           2. âœ… Merge this PR to apply changes
  #           3. ðŸ“Š Pre-migration state recording
  #           4. ðŸš€ Execute GEI migration
  #           5. ðŸ”§ Post-migration setup (admins, teams, branch protection)
  #           6. âœ… Verification checks
  #           7. ðŸ“¦ Cutover and archive (if requested)

  #           ---

  #           Closes #${issueNumber}`;

  #           const pr = await github.rest.pulls.create({
  #             owner: context.repo.owner,
  #             repo: context.repo.repo,
  #             title: `ðŸš€ GHEC Migration: ${sourceOrg}/${sourceRepo} â†’ ${targetOrg}/${targetRepo}`,
  #             head: branchName,
  #             base: 'main',
  #             body: prBody
  #           });

  #           core.setOutput('pr-number', pr.data.number);
  #           core.setOutput('pr-url', pr.data.html_url);
  #           return pr.data;

  #     - name: Comment migration PR created
  #       uses: peter-evans/create-or-update-comment@v4
  #       with:
  #         issue-number: ${{ github.event.issue.number }}
  #         body: |
  #           ### âœ… Migration Configuration Created

  #           The migration request has been **approved** and a Pull Request has been created.

  #           | Field | Value |
  #           |-------|-------|
  #           | **Source** | `${{ needs.validate.outputs.source_organization }}/${{ needs.validate.outputs.source_repo }}` |
  #           | **Target** | `${{ needs.validate.outputs.target_organization }}/${{ needs.validate.outputs.target_repo }}` |
  #           | **Visibility** | `${{ needs.validate.outputs.target_visibility }}` |
  #           | **Admins** | `${{ needs.validate.outputs.admins }}` |
  #           | **Pull Request** | #${{ steps.create-pr.outputs.pr-number }} |

  #           â³ Proceeding to pre-migration setup once PR is merged...

  #     - name: Add labels to PR
  #       uses: actions/github-script@v7
  #       with:
  #         script: |
  #           await github.rest.issues.addLabels({
  #             owner: context.repo.owner,
  #             repo: context.repo.repo,
  #             issue_number: ${{ steps.create-pr.outputs.pr-number }},
  #             labels: ['migration-request', 'automated']
  #           });

  #     - name: Generate PR creation summary
  #       if: success()
  #       uses: actions/github-script@v7
  #       with:
  #         script: |
  #           const sourceOrg = '${{ needs.validate.outputs.source_organization }}';
  #           const sourceRepo = '${{ needs.validate.outputs.source_repo }}';
  #           const targetOrg = '${{ needs.validate.outputs.target_organization }}';
  #           const targetRepo = '${{ needs.validate.outputs.target_repo }}';
  #           const targetVisibility = '${{ needs.validate.outputs.target_visibility }}';
  #           const migrationOptions = '${{ needs.validate.outputs.migration_options }}';
  #           const admins = '${{ needs.validate.outputs.admins }}';
  #           const teamMappings = '${{ needs.validate.outputs.team_mappings }}';
  #           const justification = '${{ needs.validate.outputs.justification }}';
  #           const prUrl = '${{ steps.create-pr.outputs.pr-url }}';
  #           const prNumber = '${{ steps.create-pr.outputs.pr-number }}';

  #           const adminsList = admins && admins !== '_No response_'
  #             ? admins.split(',').map(a => a.trim().replace(/^@/, ''))
  #             : [];

  #           const optionsList = migrationOptions
  #             ? migrationOptions.split(',').map(o => o.trim()).filter(o => o)
  #             : [];

  #           let summary = '# âœ… Pull Request Created Successfully!\n\n';
  #           summary += '## ðŸš€ GHEC Migration Configuration Ready\n\n';
  #           summary += '| Field | Value |\n';
  #           summary += '|-------|-------|\n';
  #           summary += `| **Source Repository** | \`${sourceOrg}/${sourceRepo}\` |\n`;
  #           summary += `| **Target Repository** | \`${targetOrg}/${targetRepo}\` |\n`;
  #           summary += `| **Target Visibility** | \`${targetVisibility}\` |\n`;
  #           summary += `| **Admins** | ${adminsList.map(a => `\`${a}\``).join(', ') || 'None'} |\n`;
  #           summary += `| **Pull Request** | [#${prNumber}](${prUrl}) |\n\n`;

  #           if (optionsList.length > 0) {
  #             summary += '## âš™ï¸ Migration Options\n\n';
  #             for (const option of optionsList) {
  #               summary += `- âœ… ${option}\n`;
  #             }
  #             summary += '\n';
  #           }

  #           if (adminsList.length > 0) {
  #             summary += '## ðŸ‘¤ Admins\n\n';
  #             summary += '| Admin | Permission | Status |\n';
  #             summary += '|-------|------------|--------|\n';
  #             for (const admin of adminsList) {
  #               summary += `| \`${admin}\` | admin | Will be added post-migration |\n`;
  #             }
  #             summary += '\n';
  #           }

  #           if (teamMappings && teamMappings !== '_No response_') {
  #             summary += '## ðŸ‘¥ Team Access Mappings\n\n';
  #             summary += '```\n';
  #             summary += teamMappings + '\n';
  #             summary += '```\n\n';
  #           }

  #           if (justification && justification !== '_No response_') {
  #             summary += '## ðŸ“ Justification\n\n';
  #             summary += `> ${justification}\n\n`;
  #           }

  #           summary += '## ðŸ“‹ Next Steps\n\n';
  #           summary += `1. ðŸ“ Review the PR: [#${prNumber}](${prUrl})\n`;
  #           summary += `2. âœ… Approve and merge the PR\n`;
  #           summary += `3. ðŸ“Š Pre-migration state recording\n`;
  #           summary += `4. ðŸš€ Execute GEI migration\n`;
  #           summary += `5. ðŸ”§ Post-migration setup (admins, teams, branch protection)\n`;
  #           summary += `6. âœ… Verification checks\n`;
  #           summary += `7. ðŸ“¦ Cutover and archive (if requested)\n\n`;

  #           summary += '---\n\n';
  #           summary += `*PR created for issue #${context.issue.number}*\n`;

  #           await core.summary
  #             .addRaw(summary)
  #             .write();

  #     - name: Post success comment
  #       if: success()
  #       uses: actions/github-script@v7
  #       with:
  #         script: |
  #           const sourceOrg = '${{ needs.validate.outputs.source_organization }}';
  #           const sourceRepo = '${{ needs.validate.outputs.source_repo }}';
  #           const targetOrg = '${{ needs.validate.outputs.target_organization }}';
  #           const targetRepo = '${{ needs.validate.outputs.target_repo }}';
  #           const targetVisibility = '${{ needs.validate.outputs.target_visibility }}';
  #           const migrationOptions = '${{ needs.validate.outputs.migration_options }}';
  #           const admins = '${{ needs.validate.outputs.admins }}';
  #           const teamMappings = '${{ needs.validate.outputs.team_mappings }}';
  #           const prUrl = '${{ steps.create-pr.outputs.pr-url }}';
  #           const prNumber = '${{ steps.create-pr.outputs.pr-number }}';

  #           const adminsList = admins && admins !== '_No response_'
  #             ? admins.split(',').map(a => a.trim().replace(/^@/, ''))
  #             : [];

  #           const optionsList = migrationOptions
  #             ? migrationOptions.split(',').map(o => o.trim()).filter(o => o)
  #             : [];

  #           let commentBody = `## âœ… Pull Request Created!

  #           A pull request has been created to add your migration configuration.

  #           ### ðŸš€ Migration Details
  #           - **Source Repository:** \`${sourceOrg}/${sourceRepo}\`
  #           - **Target Repository:** \`${targetOrg}/${targetRepo}\`
  #           - **Target Visibility:** \`${targetVisibility}\`
  #           - **Pull Request:** [#${prNumber}](${prUrl})

  #           `;

  #           if (optionsList.length > 0) {
  #             commentBody += '### âš™ï¸ Migration Options\n';
  #             for (const option of optionsList) {
  #               commentBody += `- âœ… ${option}\n`;
  #             }
  #             commentBody += '\n';
  #           }

  #           if (adminsList.length > 0) {
  #             commentBody += '### ðŸ‘¤ Admins\n';
  #             for (const admin of adminsList) {
  #               commentBody += `- \`${admin}\` - Admin access (will be added post-migration)\n`;
  #             }
  #             commentBody += '\n';
  #           }

  #           if (teamMappings && teamMappings !== '_No response_') {
  #             commentBody += '### ðŸ‘¥ Team Access Mappings\n';
  #             commentBody += '```\n';
  #             commentBody += teamMappings + '\n';
  #             commentBody += '```\n\n';
  #           }

  #           commentBody += `### ðŸ“‹ Next Steps
  #           1. ðŸ“ Review the pull request: [#${prNumber}](${prUrl})
  #           2. âœ… Approve and merge the PR
  #           3. ðŸ“Š Pre-migration state recording
  #           4. ðŸš€ Execute GEI migration
  #           5. ðŸ”§ Post-migration setup (admins, teams, branch protection)
  #           6. âœ… Verification checks
  #           7. ðŸ“¦ Cutover and archive (if requested)

  #           ---
  #           *Automated by GitHub Actions workflow*`;

  #           await github.rest.issues.createComment({
  #             issue_number: context.issue.number,
  #             owner: context.repo.owner,
  #             repo: context.repo.repo,
  #             body: commentBody
  #           });

  #           // Link issue to PR (will be closed when PR is merged)
  #           await github.rest.issues.addLabels({
  #             issue_number: context.issue.number,
  #             owner: context.repo.owner,
  #             repo: context.repo.repo,
  #             labels: ['pr-created']
  #           });

  #     - name: Generate failure summary
  #       if: failure()
  #       uses: actions/github-script@v7
  #       with:
  #         script: |
  #           const sourceOrg = '${{ needs.validate.outputs.source_organization }}';
  #           const sourceRepo = '${{ needs.validate.outputs.source_repo }}';
  #           const targetOrg = '${{ needs.validate.outputs.target_organization }}';
  #           const targetRepo = '${{ needs.validate.outputs.target_repo }}';

  #           let summary = '# âŒ Migration Configuration Failed\n\n';
  #           summary += '## ðŸš¨ Error Information\n\n';
  #           summary += '| Field | Value |\n';
  #           summary += '|-------|-------|\n';
  #           summary += `| **Source Repository** | \`${sourceOrg}/${sourceRepo}\` |\n`;
  #           summary += `| **Target Repository** | \`${targetOrg}/${targetRepo}\` |\n`;
  #           summary += `| **Workflow Run** | [View Logs](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}) |\n`;
  #           summary += `| **Issue** | #${context.issue.number} |\n\n`;

  #           summary += '## ðŸ”§ Troubleshooting Steps\n\n';
  #           summary += '1. ðŸ“‹ Check the workflow logs for detailed error messages\n';
  #           summary += '2. ðŸ” Verify that all required permissions are in place\n';
  #           summary += '3. ðŸ”‘ Ensure GH_SOURCE_PAT and GH_TARGET_PAT secrets are valid\n';
  #           summary += '4. ðŸ”„ Ensure no manual changes conflict with automation\n';
  #           summary += '5. ðŸ‘¥ Contact DevSecOps team for assistance\n\n';

  #           summary += '---\n\n';
  #           summary += '> âš ï¸ A member of the DevSecOps team will investigate and follow up.\n';

  #           await core.summary
  #             .addRaw(summary)
  #             .write();

  #     - name: Post failure comment
  #       if: failure()
  #       uses: actions/github-script@v7
  #       with:
  #         script: |
  #           const sourceOrg = '${{ needs.validate.outputs.source_organization }}';
  #           const sourceRepo = '${{ needs.validate.outputs.source_repo }}';
  #           const targetOrg = '${{ needs.validate.outputs.target_organization }}';
  #           const targetRepo = '${{ needs.validate.outputs.target_repo }}';

  #           const commentBody = `## âŒ Migration Configuration Failed

  #           There was an error creating the migration configuration. Please check the workflow logs for details.

  #           ### Error Details
  #           - **Source Repository:** \`${sourceOrg}/${sourceRepo}\`
  #           - **Target Repository:** \`${targetOrg}/${targetRepo}\`
  #           - **Workflow Run:** [View Logs](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})
  #           - **Step Failed:** Check the logs above

  #           ### ðŸ”§ Troubleshooting
  #           A member of the DevSecOps team will investigate and follow up.

  #           ---
  #           *Automated by GitHub Actions workflow*`;

  #           await github.rest.issues.createComment({
  #             issue_number: context.issue.number,
  #             owner: context.repo.owner,
  #             repo: context.repo.repo,
  #             body: commentBody
  #           });

  #           // Add failure label
  #           await github.rest.issues.addLabels({
  #             issue_number: context.issue.number,
  #             owner: context.repo.owner,
  #             repo: context.repo.repo,
  #             labels: ['migration-failed']
  #           });

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Job 2: Approval Gate - requires manual approval after validation
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  approval:
    name: "Migration Approval Gate"
    needs: validate
    runs-on: ubuntu-latest
    environment:
      name: migration-approval
    permissions:
      issues: write
    steps:
      - name: Comment approval requested
        uses: peter-evans/create-or-update-comment@v4
        with:
          issue-number: ${{ github.event.issue.number }}
          body: |
            ### ðŸ” Approval Required

            Validation has passed. A manual approval is now required to proceed with the migration.

            | Field | Value |
            |-------|-------|
            | **Source** | `${{ needs.validate.outputs.source_organization }}/${{ needs.validate.outputs.source_repo }}` |
            | **Target** | `${{ needs.validate.outputs.target_organization }}/${{ needs.validate.outputs.target_repo }}` |
            | **Visibility** | `${{ needs.validate.outputs.target_visibility }}` |

            â³ Waiting for a member of the **migration-approval** environment reviewers to approve...

            ---
            *Automated by GitHub Actions workflow*

      - name: Approval granted
        run: echo "âœ… Migration approved â€” proceeding to next steps."

      - name: Comment approval granted
        uses: peter-evans/create-or-update-comment@v4
        with:
          issue-number: ${{ github.event.issue.number }}
          body: |
            ### âœ… Migration Approved

            The migration has been approved. Proceeding with the next steps.

            ---
            *Automated by GitHub Actions workflow*
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Job 2: Pre-migration â€” record state & lock
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  pre-migration:
    name: "Pre-Migration Setup"
    needs: [validate, approval]
    runs-on: ubuntu-latest
    permissions:
      issues: write
    outputs:
      source_branches: ${{ steps.stats.outputs.branches }}
      source_tags: ${{ steps.stats.outputs.tags }}
      source_head_sha: ${{ steps.stats.outputs.head_sha }}
      source_default_branch: ${{ steps.stats.outputs.default_branch }}
      archive_source: ${{ steps.options.outputs.archive_source }}

    steps:
      - name: Parse migration options
        id: options
        run: |
          OPTIONS="${{ needs.validate.outputs.migration_options }}"
          echo "Raw options: $OPTIONS"

          if echo "$OPTIONS" | grep -qi "Archive source repository"; then
            echo "archive_source=true" >> $GITHUB_OUTPUT
          else
            echo "archive_source=false" >> $GITHUB_OUTPUT
          fi

      - name: Record source repository state
        id: stats
        run: |
          SRC_ORG="${{ needs.validate.outputs.source_organization }}"
          SRC_REPO="${{ needs.validate.outputs.source_repo }}"
          TOKEN="${{ secrets.GH_SOURCE_PAT }}"

          # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          # [GHES â†’ GHEC] Set API_BASE to GHES API URL instead:
          #   API_BASE="${{ secrets.GHES_API_URL }}"
          # Then replace all "https://api.github.com" below with "${API_BASE}"
          # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

          # Get repo info
          REPO_JSON=$(curl -s \
            -H "Authorization: Bearer $TOKEN" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/${SRC_ORG}/${SRC_REPO}")

          DEFAULT_BRANCH=$(echo "$REPO_JSON" | jq -r '.default_branch // "main"')
          echo "default_branch=$DEFAULT_BRANCH" >> $GITHUB_OUTPUT

          # Branch count
          BRANCHES=$(curl -s \
            -H "Authorization: Bearer $TOKEN" \
            "https://api.github.com/repos/${SRC_ORG}/${SRC_REPO}/branches?per_page=100" | jq 'length')
          echo "branches=$BRANCHES" >> $GITHUB_OUTPUT

          # Tag count
          TAGS=$(curl -s \
            -H "Authorization: Bearer $TOKEN" \
            "https://api.github.com/repos/${SRC_ORG}/${SRC_REPO}/tags?per_page=100" | jq 'length')
          echo "tags=$TAGS" >> $GITHUB_OUTPUT

          # HEAD SHA
          BRANCH_JSON=$(curl -s \
            -H "Authorization: Bearer $TOKEN" \
            "https://api.github.com/repos/${SRC_ORG}/${SRC_REPO}/branches/${DEFAULT_BRANCH}")
          HEAD_SHA=$(echo "$BRANCH_JSON" | jq -r '.commit.sha // "unknown"')
          echo "head_sha=$HEAD_SHA" >> $GITHUB_OUTPUT

          echo "ðŸ“Š Source repository state recorded:"
          echo "   Default branch: $DEFAULT_BRANCH"
          echo "   Branches: $BRANCHES"
          echo "   Tags: $TAGS"
          echo "   HEAD SHA: ${HEAD_SHA:0:12}"

      - name: Comment pre-migration state
        uses: peter-evans/create-or-update-comment@v4
        with:
          issue-number: ${{ needs.validate.outputs.issue_number }}
          body: |
            ### ðŸ“Š Pre-Migration State Recorded

            | Metric | Value |
            |--------|-------|
            | **Branches** | ${{ steps.stats.outputs.branches }} |
            | **Tags** | ${{ steps.stats.outputs.tags }} |
            | **Default Branch** | ${{ steps.stats.outputs.default_branch }} |
            | **HEAD SHA** | `${{ steps.stats.outputs.head_sha }}` |

            â³ Starting GEI migration...

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Job 3: Execute migration via GEI
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  migrate:
    name: "Execute GEI Migration"
    needs: [validate, pre-migration]
    runs-on: ubuntu-latest
    permissions:
      issues: write

    steps:
      - name: Install GEI CLI
        run: |
          gh extension install github/gh-gei || true
          gh gei --version
        env:
          GH_TOKEN: ${{ secrets.GH_TARGET_PAT }}

      - name: Run GEI migration
        id: gei
        run: |
          SRC_ORG="${{ needs.validate.outputs.source_organization }}"
          SRC_REPO="${{ needs.validate.outputs.source_repo }}"
          TGT_ORG="${{ needs.validate.outputs.target_organization }}"
          TGT_REPO="${{ needs.validate.outputs.target_repo }}"
          VISIBILITY="${{ needs.validate.outputs.target_visibility }}"

          echo "ðŸš€ Starting GEI migration..."
          echo "   Source: ${SRC_ORG}/${SRC_REPO} (GitHub.com)"
          echo "   Target: ${TGT_ORG}/${TGT_REPO} (GitHub.com)"
          echo "   Visibility: ${VISIBILITY}"

          # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          # [GHES â†’ GHEC] Replace the migrate-repo command below with:
          #
          #   gh gei migrate-repo \
          #     --ghes-api-url "${{ secrets.GHES_API_URL }}" \
          #     --github-source-org "$SRC_ORG" \
          #     --source-repo "$SRC_REPO" \
          #     --github-target-org "$TGT_ORG" \
          #     --target-repo "$TGT_REPO" \
          #     --target-repo-visibility "$VISIBILITY" \
          #     --verbose 2>&1 | tee /tmp/gei_output.txt
          #
          # Key difference: --ghes-api-url tells GEI the source is a GHES instance.
          # The GH_SOURCE_PAT must be a PAT from your GHES instance.
          # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          gh gei migrate-repo \
            --github-source-org "$SRC_ORG" \
            --source-repo "$SRC_REPO" \
            --github-target-org "$TGT_ORG" \
            --target-repo "$TGT_REPO" \
            --target-repo-visibility "$VISIBILITY" \
            --verbose 2>&1 | tee /tmp/gei_output.txt

          GEI_EXIT=$?
          echo "exit_code=$GEI_EXIT" >> $GITHUB_OUTPUT

          if [ "$GEI_EXIT" -ne 0 ]; then
            echo "âŒ GEI migration failed"
            exit 1
          fi

          echo "âœ… GEI migration command completed"
        env:
          GH_SOURCE_PAT: ${{ secrets.GH_SOURCE_PAT }}
          GH_PAT: ${{ secrets.GH_TARGET_PAT }}

      - name: Comment migration result
        if: always()
        uses: peter-evans/create-or-update-comment@v4
        with:
          issue-number: ${{ needs.validate.outputs.issue_number }}
          body: |
            ### GEI Migration ${{ steps.gei.outcome == 'success' && 'âœ…' || 'âŒ' }}

            **Source:** `${{ needs.validate.outputs.source_organization }}/${{ needs.validate.outputs.source_repo }}`
            **Target:** `${{ needs.validate.outputs.target_organization }}/${{ needs.validate.outputs.target_repo }}`

            <details><summary>GEI Output</summary>

            ```
            $(cat /tmp/gei_output.txt 2>/dev/null || echo "No output captured")
            ```

            </details>

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Job 4: Post-migration setup
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  post-migration:
    name: "Post-Migration Setup"
    needs: [validate, pre-migration, migrate]
    runs-on: ubuntu-latest
    permissions:
      issues: write

    steps:
      - name: Wait for GitHub.com to finalize
        run: |
          echo "â³ Waiting 15 seconds for GitHub.com to finalize import..."
          sleep 15

      - name: Add admin collaborators
        run: |
          TGT_ORG="${{ needs.validate.outputs.target_organization }}"
          TGT_REPO="${{ needs.validate.outputs.target_repo }}"
          ADMINS="${{ needs.validate.outputs.admins }}"
          TOKEN="${{ secrets.GH_TARGET_PAT }}"

          echo "ðŸ‘¥ Adding admin collaborators..."

          IFS=',' read -ra ADMIN_ARRAY <<< "$ADMINS"
          for RAW_ADMIN in "${ADMIN_ARRAY[@]}"; do
            ADMIN=$(echo "$RAW_ADMIN" | xargs | sed 's/^@//')
            if [ -z "$ADMIN" ]; then continue; fi

            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" \
              -X PUT \
              -H "Authorization: Bearer $TOKEN" \
              -H "Accept: application/vnd.github+json" \
              -H "Content-Type: application/json" \
              -d '{"permission": "admin"}' \
              "https://api.github.com/repos/${TGT_ORG}/${TGT_REPO}/collaborators/${ADMIN}")

            if [ "$HTTP_CODE" = "201" ] || [ "$HTTP_CODE" = "204" ]; then
              echo "   âœ… $ADMIN â€” added as admin"
            else
              echo "   âš ï¸ $ADMIN â€” HTTP $HTTP_CODE"
            fi
          done

      - name: Apply team access mappings
        if: needs.validate.outputs.team_mappings != ''
        run: |
          TGT_ORG="${{ needs.validate.outputs.target_organization }}"
          TGT_REPO="${{ needs.validate.outputs.target_repo }}"
          TOKEN="${{ secrets.GH_TARGET_PAT }}"

          echo "ðŸ‘¥ Applying team access mappings..."

          MAPPINGS="${{ needs.validate.outputs.team_mappings }}"
          echo "$MAPPINGS" | while IFS= read -r LINE; do
            LINE=$(echo "$LINE" | xargs)
            [ -z "$LINE" ] && continue
            [[ "$LINE" == \#* ]] && continue

            # Parse: source-team â†’ target-team : permission
            if echo "$LINE" | grep -q "â†’"; then
              TARGET_PART=$(echo "$LINE" | sed 's/.*â†’//' | xargs)
            elif echo "$LINE" | grep -q "->"; then
              TARGET_PART=$(echo "$LINE" | sed 's/.*->//' | xargs)
            else
              echo "   âš ï¸ Skipping invalid mapping: $LINE"
              continue
            fi

            if echo "$TARGET_PART" | grep -q ":"; then
              TARGET_TEAM=$(echo "$TARGET_PART" | sed 's/:.*//' | xargs)
              PERMISSION=$(echo "$TARGET_PART" | sed 's/.*://' | xargs)
            else
              TARGET_TEAM="$TARGET_PART"
              PERMISSION="push"
            fi

            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" \
              -X PUT \
              -H "Authorization: Bearer $TOKEN" \
              -H "Accept: application/vnd.github+json" \
              -H "Content-Type: application/json" \
              -d "{\"permission\": \"$PERMISSION\"}" \
              "https://api.github.com/orgs/${TGT_ORG}/teams/${TARGET_TEAM}/repos/${TGT_ORG}/${TGT_REPO}")

            if [ "$HTTP_CODE" = "204" ]; then
              echo "   âœ… $TARGET_TEAM â€” $PERMISSION"
            else
              echo "   âš ï¸ $TARGET_TEAM â€” HTTP $HTTP_CODE"
            fi
          done

      - name: Enable branch protection
        run: |
          TGT_ORG="${{ needs.validate.outputs.target_organization }}"
          TGT_REPO="${{ needs.validate.outputs.target_repo }}"
          DEFAULT_BRANCH="${{ needs.pre-migration.outputs.source_default_branch }}"
          TOKEN="${{ secrets.GH_TARGET_PAT }}"

          echo "ðŸ›¡ï¸ Enabling branch protection on '${DEFAULT_BRANCH}'..."

          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" \
            -X PUT \
            -H "Authorization: Bearer $TOKEN" \
            -H "Accept: application/vnd.github+json" \
            -H "Content-Type: application/json" \
            -d '{
              "required_status_checks": null,
              "enforce_admins": true,
              "required_pull_request_reviews": {
                "required_approving_review_count": 1,
                "dismiss_stale_reviews": true
              },
              "restrictions": null
            }' \
            "https://api.github.com/repos/${TGT_ORG}/${TGT_REPO}/branches/${DEFAULT_BRANCH}/protection")

          if [ "$HTTP_CODE" = "200" ]; then
            echo "   âœ… Branch protection enabled"
          else
            echo "   âš ï¸ Branch protection returned HTTP $HTTP_CODE"
          fi

      - name: Migrate Advanced Security permissions from source to target
        id: migrate-ghas
        run: |
          SRC_ORG="${{ needs.validate.outputs.source_organization }}"
          SRC_REPO="${{ needs.validate.outputs.source_repo }}"
          TGT_ORG="${{ needs.validate.outputs.target_organization }}"
          TGT_REPO="${{ needs.validate.outputs.target_repo }}"
          SRC_TOKEN="${{ secrets.GH_SOURCE_PAT }}"
          TGT_TOKEN="${{ secrets.GH_TARGET_PAT }}"

          # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          # [GHES â†’ GHEC] Source API base URL:
          # For GHES source, use the GHES API URL.
          # For GHEC-to-GHEC, change this to https://api.github.com
          # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          SRC_API_BASE="https://api.github.com"
          # [GHES â†’ GHEC] Uncomment the line below and comment the line above:
          # SRC_API_BASE="${{ secrets.GHES_API_URL }}"
          TGT_API_BASE="https://api.github.com"

          echo "ðŸ”’ Migrating Advanced Security (GHAS) permissions from ${SRC_ORG}/${SRC_REPO} â†’ ${TGT_ORG}/${TGT_REPO}..."

          GHAS_MANUAL_FILE=$(mktemp)
          GHAS_STATUS="success"

          # â”€â”€ 1. Read source repo security settings â”€â”€
          echo "ðŸ“‹ Reading source repository security settings..."
          SRC_REPO_JSON=$(curl -s \
            -H "Authorization: Bearer $SRC_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            "${SRC_API_BASE}/repos/${SRC_ORG}/${SRC_REPO}")

          # Extract security_and_analysis settings from source
          SRC_ADVANCED_SECURITY=$(echo "$SRC_REPO_JSON" | jq -r '.security_and_analysis.advanced_security.status // "disabled"')
          SRC_SECRET_SCANNING=$(echo "$SRC_REPO_JSON" | jq -r '.security_and_analysis.secret_scanning.status // "disabled"')
          SRC_SECRET_SCANNING_PUSH=$(echo "$SRC_REPO_JSON" | jq -r '.security_and_analysis.secret_scanning_push_protection.status // "disabled"')
          SRC_SECRET_SCANNING_VALIDITY=$(echo "$SRC_REPO_JSON" | jq -r '.security_and_analysis.secret_scanning_validity_checks.status // "disabled"')
          SRC_SECRET_SCANNING_NON_PROVIDER=$(echo "$SRC_REPO_JSON" | jq -r '.security_and_analysis.secret_scanning_non_provider_patterns.status // "disabled"')
          SRC_DEPENDABOT_ALERTS=$(echo "$SRC_REPO_JSON" | jq -r '.security_and_analysis.dependabot_security_updates.status // "disabled"')

          echo "   Source GHAS settings:"
          echo "     Advanced Security:                    $SRC_ADVANCED_SECURITY"
          echo "     Secret Scanning:                      $SRC_SECRET_SCANNING"
          echo "     Secret Scanning Push Protection:      $SRC_SECRET_SCANNING_PUSH"
          echo "     Secret Scanning Validity Checks:      $SRC_SECRET_SCANNING_VALIDITY"
          echo "     Secret Scanning Non-Provider Patterns: $SRC_SECRET_SCANNING_NON_PROVIDER"
          echo "     Dependabot Security Updates:          $SRC_DEPENDABOT_ALERTS"

          # â”€â”€ 2. Enable Advanced Security on target (must be enabled first) â”€â”€
          if [ "$SRC_ADVANCED_SECURITY" = "enabled" ]; then
            echo "ðŸ“‹ Enabling GitHub Advanced Security on target..."
            GHAS_PAYLOAD=$(jq -n '{
              security_and_analysis: {
                advanced_security: { status: "enabled" }
              }
            }')

            HTTP_CODE=$(curl -s -o /tmp/ghas_response.json -w "%{http_code}" \
              -X PATCH \
              -H "Authorization: Bearer $TGT_TOKEN" \
              -H "Accept: application/vnd.github+json" \
              -H "Content-Type: application/json" \
              -d "$GHAS_PAYLOAD" \
              "${TGT_API_BASE}/repos/${TGT_ORG}/${TGT_REPO}")

            if [[ "$HTTP_CODE" =~ ^2 ]]; then
              echo "   âœ… GitHub Advanced Security enabled on target"
            else
              ERROR_MSG=$(cat /tmp/ghas_response.json | jq -r '.message // "Unknown error"')
              echo "   âš ï¸ Failed to enable Advanced Security â€” HTTP $HTTP_CODE â€” $ERROR_MSG"
              echo "- Enable GitHub Advanced Security (GHAS)" >> "$GHAS_MANUAL_FILE"
              GHAS_STATUS="partial"
            fi
          else
            echo "   â„¹ï¸ Advanced Security not enabled on source â€” skipping"
          fi

          # â”€â”€ 3. Apply Secret Scanning + Push Protection + Validity Checks â”€â”€
          echo "ðŸ“‹ Applying secret scanning settings on target..."
          SEC_PAYLOAD=$(jq -n \
            --arg ss "$SRC_SECRET_SCANNING" \
            --arg pp "$SRC_SECRET_SCANNING_PUSH" \
            --arg vc "$SRC_SECRET_SCANNING_VALIDITY" \
            --arg np "$SRC_SECRET_SCANNING_NON_PROVIDER" \
            '{
              security_and_analysis: {
                secret_scanning: { status: $ss },
                secret_scanning_push_protection: { status: $pp },
                secret_scanning_validity_checks: { status: $vc },
                secret_scanning_non_provider_patterns: { status: $np }
              }
            }')

          HTTP_CODE=$(curl -s -o /tmp/secret_scan_response.json -w "%{http_code}" \
            -X PATCH \
            -H "Authorization: Bearer $TGT_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            -H "Content-Type: application/json" \
            -d "$SEC_PAYLOAD" \
            "${TGT_API_BASE}/repos/${TGT_ORG}/${TGT_REPO}")

          if [[ "$HTTP_CODE" =~ ^2 ]]; then
            echo "   âœ… Secret scanning settings applied"
            [ "$SRC_SECRET_SCANNING" = "enabled" ] && echo "      â€¢ Secret scanning: enabled"
            [ "$SRC_SECRET_SCANNING_PUSH" = "enabled" ] && echo "      â€¢ Push protection: enabled"
            [ "$SRC_SECRET_SCANNING_VALIDITY" = "enabled" ] && echo "      â€¢ Validity checks: enabled"
            [ "$SRC_SECRET_SCANNING_NON_PROVIDER" = "enabled" ] && echo "      â€¢ Non-provider patterns: enabled"
          else
            ERROR_MSG=$(cat /tmp/secret_scan_response.json | jq -r '.message // "Unknown error"')
            echo "   âš ï¸ Failed to apply secret scanning settings â€” HTTP $HTTP_CODE â€” $ERROR_MSG"
            echo "   ðŸ“‹ Full response: $(cat /tmp/secret_scan_response.json)"
            echo "- Secret scanning settings (scanning, push protection, validity checks, non-provider patterns)" >> "$GHAS_MANUAL_FILE"
            GHAS_STATUS="partial"
          fi

          # â”€â”€ 4. Enable Dependabot security updates â”€â”€
          echo "ðŸ“‹ Applying Dependabot security updates setting..."
          if [ "$SRC_DEPENDABOT_ALERTS" = "enabled" ]; then
            # First enable vulnerability alerts (required before security updates)
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" \
              -X PUT \
              -H "Authorization: Bearer $TGT_TOKEN" \
              -H "Accept: application/vnd.github+json" \
              "${TGT_API_BASE}/repos/${TGT_ORG}/${TGT_REPO}/vulnerability-alerts")

            if [[ "$HTTP_CODE" =~ ^2 ]]; then
              echo "   âœ… Dependabot vulnerability alerts enabled"
            else
              echo "   âš ï¸ Failed to enable vulnerability alerts â€” HTTP $HTTP_CODE"
              echo "- Dependabot vulnerability alerts" >> "$GHAS_MANUAL_FILE"
              GHAS_STATUS="partial"
            fi

            # Enable Dependabot security updates
            DEPENDABOT_PAYLOAD=$(jq -n '{
              security_and_analysis: {
                dependabot_security_updates: { status: "enabled" }
              }
            }')

            HTTP_CODE=$(curl -s -o /tmp/dependabot_response.json -w "%{http_code}" \
              -X PATCH \
              -H "Authorization: Bearer $TGT_TOKEN" \
              -H "Accept: application/vnd.github+json" \
              -H "Content-Type: application/json" \
              -d "$DEPENDABOT_PAYLOAD" \
              "${TGT_API_BASE}/repos/${TGT_ORG}/${TGT_REPO}")

            if [[ "$HTTP_CODE" =~ ^2 ]]; then
              echo "   âœ… Dependabot security updates enabled"
            else
              ERROR_MSG=$(cat /tmp/dependabot_response.json | jq -r '.message // "Unknown error"')
              echo "   âš ï¸ Failed to enable Dependabot security updates â€” HTTP $HTTP_CODE â€” $ERROR_MSG"
              echo "- Dependabot security updates" >> "$GHAS_MANUAL_FILE"
              GHAS_STATUS="partial"
            fi
          else
            echo "   â„¹ï¸ Dependabot security updates not enabled on source â€” skipping"
          fi

          # â”€â”€ 5. Migrate Code Scanning default setup configuration â”€â”€
          echo "ðŸ“‹ Reading code scanning default setup from source..."
          SRC_CODE_SCANNING=$(curl -s \
            -H "Authorization: Bearer $SRC_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            "${SRC_API_BASE}/repos/${SRC_ORG}/${SRC_REPO}/code-scanning/default-setup")

          CS_STATE=$(echo "$SRC_CODE_SCANNING" | jq -r '.state // "not-configured"')
          echo "   Source code scanning default setup state: $CS_STATE"

          if [ "$CS_STATE" = "configured" ]; then
            CS_QUERY_SUITE=$(echo "$SRC_CODE_SCANNING" | jq -r '.query_suite // "default"')
            CS_LANGUAGES=$(echo "$SRC_CODE_SCANNING" | jq -c '.languages // []')

            echo "   Source code scanning: query_suite=$CS_QUERY_SUITE, languages=$CS_LANGUAGES"

            CS_PAYLOAD=$(jq -n \
              --arg state "configured" \
              --arg query_suite "$CS_QUERY_SUITE" \
              --argjson languages "$CS_LANGUAGES" \
              '{
                state: $state,
                query_suite: $query_suite,
                languages: $languages
              }')

            HTTP_CODE=$(curl -s -o /tmp/code_scanning_response.json -w "%{http_code}" \
              -X PATCH \
              -H "Authorization: Bearer $TGT_TOKEN" \
              -H "Accept: application/vnd.github+json" \
              -H "Content-Type: application/json" \
              -d "$CS_PAYLOAD" \
              "${TGT_API_BASE}/repos/${TGT_ORG}/${TGT_REPO}/code-scanning/default-setup")

            if [[ "$HTTP_CODE" =~ ^2 ]]; then
              echo "   âœ… Code scanning default setup configured (query_suite=$CS_QUERY_SUITE)"
            else
              ERROR_MSG=$(cat /tmp/code_scanning_response.json | jq -r '.message // "Unknown error"')
              echo "   âš ï¸ Failed to configure code scanning â€” HTTP $HTTP_CODE â€” $ERROR_MSG"
              echo "   ðŸ“‹ Full response: $(cat /tmp/code_scanning_response.json)"
              echo "- Code scanning default setup (query_suite=$CS_QUERY_SUITE, languages=$CS_LANGUAGES)" >> "$GHAS_MANUAL_FILE"
              GHAS_STATUS="partial"
            fi
          else
            echo "   â„¹ï¸ Code scanning default setup not configured on source â€” skipping"
          fi

          # â”€â”€ 6. Migrate security manager teams (org-level â€” informational only) â”€â”€
          echo "ðŸ“‹ Checking security manager teams on source org..."
          SEC_MANAGERS=$(curl -s \
            -H "Authorization: Bearer $SRC_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            "${SRC_API_BASE}/orgs/${SRC_ORG}/security-managers")

          if echo "$SEC_MANAGERS" | jq -e 'type == "array" and length > 0' > /dev/null 2>&1; then
            SM_TEAMS=$(echo "$SEC_MANAGERS" | jq -r '.[].slug' | tr '\n' ', ' | sed 's/,$//')
            echo "   â„¹ï¸ Source org security manager teams: $SM_TEAMS"
            echo "   âš ï¸ Security manager teams are org-level and must be configured manually on target org"
            echo "- Security manager teams (org-level): $SM_TEAMS" >> "$GHAS_MANUAL_FILE"
          else
            echo "   â„¹ï¸ No security manager teams found (or no access)"
          fi

          # â”€â”€ Summary â”€â”€
          echo ""
          if [ -s "$GHAS_MANUAL_FILE" ]; then
            echo "âš ï¸ Some GHAS settings require manual re-configuration:"
            cat "$GHAS_MANUAL_FILE"
            {
              echo "GHAS_MANUAL<<EOF"
              cat "$GHAS_MANUAL_FILE"
              echo "EOF"
            } >> "$GITHUB_ENV"
          else
            echo "âœ… All Advanced Security permissions migrated successfully"
            echo "GHAS_MANUAL=" >> "$GITHUB_ENV"
          fi

          echo "ghas_status=$GHAS_STATUS" >> $GITHUB_OUTPUT
          rm -f "$GHAS_MANUAL_FILE"
          echo "âœ… Advanced Security permissions migration complete."

      - name: Comment post-migration setup
        uses: peter-evans/create-or-update-comment@v4
        with:
          issue-number: ${{ needs.validate.outputs.issue_number }}
          body: |
            ### ðŸ”§ Post-Migration Setup Complete

            - âœ… Admin collaborators added: `${{ needs.validate.outputs.admins }}`
            - âœ… Branch protection enabled on `${{ needs.pre-migration.outputs.source_default_branch }}`
            - âœ… Team access mappings applied (if provided)
            - ${{ steps.migrate-ghas.outputs.ghas_status == 'success' && 'âœ…' || 'âš ï¸' }} Advanced Security (GHAS) permissions migrated (advanced security, secret scanning, code scanning, dependabot)

            ${{ env.GHAS_MANUAL != '' && format('#### âš ï¸ Advanced Security settings requiring manual re-configuration\n\nThe following GHAS settings were NOT migrated automatically:\n{0}\n\nPlease configure these in **Settings â†’ Code security and analysis** on the target repo.', env.GHAS_MANUAL) || '' }}

            ðŸ“‹ Running verification checks...

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Job 5: Verify migration integrity
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  verify:
    name: "Verify Migration"
    needs: [validate, pre-migration, post-migration]
    runs-on: ubuntu-latest
    permissions:
      issues: write
    outputs:
      verification_passed: ${{ steps.verify.outputs.all_pass }}

    steps:
      - name: Verify migration integrity
        id: verify
        run: |
          TGT_ORG="${{ needs.validate.outputs.target_organization }}"
          TGT_REPO="${{ needs.validate.outputs.target_repo }}"
          TOKEN="${{ secrets.GH_TARGET_PAT }}"

          SRC_BRANCHES="${{ needs.pre-migration.outputs.source_branches }}"
          SRC_TAGS="${{ needs.pre-migration.outputs.source_tags }}"
          SRC_HEAD_SHA="${{ needs.pre-migration.outputs.source_head_sha }}"
          DEFAULT_BRANCH="${{ needs.pre-migration.outputs.source_default_branch }}"

          echo "ðŸ“‹ Verifying migration integrity..."

          # Target branches
          TGT_BRANCHES=$(curl -s \
            -H "Authorization: Bearer $TOKEN" \
            "https://api.github.com/repos/${TGT_ORG}/${TGT_REPO}/branches?per_page=100" | jq 'length')

          # Target tags
          TGT_TAGS=$(curl -s \
            -H "Authorization: Bearer $TOKEN" \
            "https://api.github.com/repos/${TGT_ORG}/${TGT_REPO}/tags?per_page=100" | jq 'length')

          # Target HEAD SHA
          TGT_HEAD_SHA=$(curl -s \
            -H "Authorization: Bearer $TOKEN" \
            "https://api.github.com/repos/${TGT_ORG}/${TGT_REPO}/branches/${DEFAULT_BRANCH}" | jq -r '.commit.sha // "unknown"')

          ALL_PASS="true"

          echo ""
          echo "Check              Source          Target          Status"
          echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"

          # Branches
          if [ "$SRC_BRANCHES" = "$TGT_BRANCHES" ]; then
            echo "Branches           $SRC_BRANCHES               $TGT_BRANCHES               âœ… PASS"
          else
            echo "Branches           $SRC_BRANCHES               $TGT_BRANCHES               âŒ FAIL"
            ALL_PASS="false"
          fi

          # Tags
          if [ "$SRC_TAGS" = "$TGT_TAGS" ]; then
            echo "Tags               $SRC_TAGS               $TGT_TAGS               âœ… PASS"
          else
            echo "Tags               $SRC_TAGS               $TGT_TAGS               âŒ FAIL"
            ALL_PASS="false"
          fi

          # HEAD SHA
          SRC_SHORT="${SRC_HEAD_SHA:0:7}"
          TGT_SHORT="${TGT_HEAD_SHA:0:7}"
          if [ "$SRC_SHORT" = "$TGT_SHORT" ]; then
            echo "HEAD SHA           $SRC_SHORT          $TGT_SHORT          âœ… PASS"
          else
            echo "HEAD SHA           $SRC_SHORT          $TGT_SHORT          âŒ FAIL"
            ALL_PASS="false"
          fi

          echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
          echo "all_pass=$ALL_PASS" >> $GITHUB_OUTPUT

          # Save for comment
          echo "tgt_branches=$TGT_BRANCHES" >> $GITHUB_OUTPUT
          echo "tgt_tags=$TGT_TAGS" >> $GITHUB_OUTPUT
          echo "tgt_head_sha=$TGT_HEAD_SHA" >> $GITHUB_OUTPUT

      - name: Comment verification result
        uses: peter-evans/create-or-update-comment@v4
        with:
          issue-number: ${{ needs.validate.outputs.issue_number }}
          body: |
            ### ðŸ“‹ Migration Verification ${{ steps.verify.outputs.all_pass == 'true' && 'âœ…' || 'âš ï¸' }}

            | Check | Source | Target | Status |
            |-------|--------|--------|--------|
            | **Branches** | ${{ needs.pre-migration.outputs.source_branches }} | ${{ steps.verify.outputs.tgt_branches }} | ${{ needs.pre-migration.outputs.source_branches == steps.verify.outputs.tgt_branches && 'âœ…' || 'âŒ' }} |
            | **Tags** | ${{ needs.pre-migration.outputs.source_tags }} | ${{ steps.verify.outputs.tgt_tags }} | ${{ needs.pre-migration.outputs.source_tags == steps.verify.outputs.tgt_tags && 'âœ…' || 'âŒ' }} |
            | **HEAD SHA** | `${{ needs.pre-migration.outputs.source_head_sha }}` | `${{ steps.verify.outputs.tgt_head_sha }}` | ${{ steps.verify.outputs.all_pass == 'true' && 'âœ…' || 'âš ï¸' }} |

            **Target URL:** https://github.com/${{ needs.validate.outputs.target_organization }}/${{ needs.validate.outputs.target_repo }}

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Job 6: Cutover â€” archive source & cleanup
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  cutover:
    name: "Cutover & Cleanup"
    needs: [validate, pre-migration, verify]
    if: needs.verify.outputs.verification_passed == 'true'
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Archive source repo on GitHub.com (if requested)
        if: needs.pre-migration.outputs.archive_source == 'true'
        run: |
          SRC_ORG="${{ needs.validate.outputs.source_organization }}"
          SRC_REPO="${{ needs.validate.outputs.source_repo }}"
          TGT_ORG="${{ needs.validate.outputs.target_organization }}"
          TGT_REPO="${{ needs.validate.outputs.target_repo }}"

          echo "ðŸ“¦ Archiving source repository on GitHub.com..."

          # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          # [GHES â†’ GHEC] Replace api.github.com with GHES API URL:
          #   HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" \
          #     -X PATCH \
          #     -H "Authorization: Bearer ${{ secrets.GH_SOURCE_PAT }}" \
          #     -H "Accept: application/vnd.github+json" \
          #     -H "Content-Type: application/json" \
          #     -d "{\"archived\": true, \"description\": \"[MIGRATED] â€” see ${TGT_ORG}/${TGT_REPO} for active development\"}" \
          #     "${{ secrets.GHES_API_URL }}/repos/${SRC_ORG}/${SRC_REPO}")
          # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" \
            -X PATCH \
            -H "Authorization: Bearer ${{ secrets.GH_SOURCE_PAT }}" \
            -H "Accept: application/vnd.github+json" \
            -H "Content-Type: application/json" \
            -d "{\"archived\": true, \"description\": \"[MIGRATED] â€” see ${TGT_ORG}/${TGT_REPO} for active development\"}" \
            "https://api.github.com/repos/${SRC_ORG}/${SRC_REPO}")

          if [ "$HTTP_CODE" = "200" ]; then
            echo "âœ… Source repository archived"
          else
            echo "âš ï¸ Failed to archive source (HTTP $HTTP_CODE)"
          fi

      # - name: Update migration manifest YAML
      #   run: |
      #     pip install pyyaml

      #     python3 - <<'PYEOF'
      #     import yaml
      #     import os
      #     from datetime import datetime

      #     manifest_path = "data/migration-manifests.yaml"

      #     # Load or create manifest
      #     if os.path.exists(manifest_path):
      #         with open(manifest_path, "r") as f:
      #             data = yaml.safe_load(f) or {}
      #     else:
      #         data = {}

      #     if "migrations" not in data or data["migrations"] is None:
      #         data["migrations"] = {}

      #     source_org = "${{ needs.validate.outputs.source_organization }}"
      #     source_repo = "${{ needs.validate.outputs.source_repo }}"
      #     target_org = "${{ needs.validate.outputs.target_organization }}"
      #     target_repo = "${{ needs.validate.outputs.target_repo }}"

      #     key = f"{source_org}-{source_repo}"

      #     data["migrations"][key] = {
      #         "source": {
      #             "platform": "github.com",
      #             "organization": source_org,
      #             "repository": source_repo,
      #         },
      #         "target": {
      #             "platform": "github.com",
      #             "organization": target_org,
      #             "repository": target_repo,
      #             "visibility": "${{ needs.validate.outputs.target_visibility }}",
      #         },
      #         "status": "completed",
      #         "completed_at": datetime.utcnow().strftime("%Y-%m-%dT%H:%M:%SZ"),
      #         "issue_number": ${{ needs.validate.outputs.issue_number }},
      #         "verification": {
      #             "source_branches": int("${{ needs.pre-migration.outputs.source_branches }}"),
      #             "source_tags": int("${{ needs.pre-migration.outputs.source_tags }}"),
      #             "source_head_sha": "${{ needs.pre-migration.outputs.source_head_sha }}",
      #         },
      #     }

      #     with open(manifest_path, "w") as f:
      #         yaml.dump(data, f, default_flow_style=False, sort_keys=False)

      #     print(f"âœ… Migration manifest updated: {key}")
      #     PYEOF

      # - name: Commit migration manifest
      #   run: |
      #     git config user.name "github-actions[bot]"
      #     git config user.email "github-actions[bot]@users.noreply.github.com"
      #     git add data/migration-manifests.yaml
      #     git diff --cached --quiet && echo "No changes to commit" || \
      #       (git commit -m "Track migration: ${{ needs.validate.outputs.source_organization }}/${{ needs.validate.outputs.source_repo }} â†’ ${{ needs.validate.outputs.target_organization }}/${{ needs.validate.outputs.target_repo }} (issue #${{ needs.validate.outputs.issue_number }})" && git push)

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Job 7: Close issue
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  close-issue:
    name: "Close Issue"
    needs: [validate, pre-migration, verify, cutover]
    if: |
      always() &&
      needs.verify.outputs.verification_passed == 'true' &&
      (needs.cutover.result == 'success' || needs.cutover.result == 'skipped')
    runs-on: ubuntu-latest
    permissions:
      issues: write

    steps:
      - name: Generate apply summary
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            const sourceOrg = '${{ needs.validate.outputs.source_organization }}';
            const sourceRepo = '${{ needs.validate.outputs.source_repo }}';
            const targetOrg = '${{ needs.validate.outputs.target_organization }}';
            const targetRepo = '${{ needs.validate.outputs.target_repo }}';
            const targetVisibility = '${{ needs.validate.outputs.target_visibility }}';
            const admins = '${{ needs.validate.outputs.admins }}';
            const migrationOptions = '${{ needs.validate.outputs.migration_options }}';
            const issueNumber = '${{ needs.validate.outputs.issue_number }}';
            const runId = context.runId;
            const runUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
            const sourceBranches = '${{ needs.pre-migration.outputs.source_branches }}';
            const sourceTags = '${{ needs.pre-migration.outputs.source_tags }}';
            const sourceHeadSha = '${{ needs.pre-migration.outputs.source_head_sha }}';
            const defaultBranch = '${{ needs.pre-migration.outputs.source_default_branch }}';
            const archiveSource = '${{ needs.pre-migration.outputs.archive_source }}';

            let summary = '# âœ… GHEC Migration Completed Successfully!\n\n';
            summary += '## ðŸŽ‰ Migration Details\n\n';
            summary += '| Field | Value |\n';
            summary += '|-------|-------|\n';
            summary += `| **Source Repository** | \`${sourceOrg}/${sourceRepo}\` |\n`;
            summary += `| **Target Repository** | [\`${targetOrg}/${targetRepo}\`](https://github.com/${targetOrg}/${targetRepo}) |\n`;
            summary += `| **Target Visibility** | \`${targetVisibility}\` |\n`;
            summary += `| **Default Branch** | \`${defaultBranch}\` |\n`;
            summary += `| **Workflow Run** | [#${runId}](${runUrl}) |\n`;
            summary += `| **Source Issue** | [#${issueNumber}](https://github.com/${context.repo.owner}/${context.repo.repo}/issues/${issueNumber}) |\n\n`;

            summary += '## ðŸ“Š Migration Verification\n\n';
            summary += '| Check | Source | Target | Status |\n';
            summary += '|-------|--------|--------|--------|\n';
            summary += `| **Branches** | ${sourceBranches} | ${sourceBranches} | âœ… PASS |\n`;
            summary += `| **Tags** | ${sourceTags} | ${sourceTags} | âœ… PASS |\n`;
            summary += `| **HEAD SHA** | \`${sourceHeadSha.substring(0, 12)}\` | \`${sourceHeadSha.substring(0, 12)}\` | âœ… PASS |\n\n`;

            if (migrationOptions) {
              summary += '## âš™ï¸ Migration Options Applied\n\n';
              const options = migrationOptions.split(',').map(o => o.trim()).filter(o => o);
              for (const option of options) {
                summary += `- âœ… ${option}\n`;
              }
              summary += '\n';
            }

            if (admins) {
              summary += '## ðŸ‘¤ Admin Access\n\n';
              summary += '| Admin | Permission | Status |\n';
              summary += '|-------|------------|--------|\n';
              const adminList = admins.split(',').map(a => a.trim().replace(/^@/, '')).filter(a => a);
              for (const admin of adminList) {
                summary += `| \`${admin}\` | admin | âœ… Added |\n`;
              }
              summary += '\n';
            }

            summary += '## ðŸ“¦ Post-Migration Actions\n\n';
            summary += `- ${archiveSource === 'true' ? 'âœ…' : 'â­ï¸'} Source repository archived after migration\n`;
            summary += `- âœ… Branch protection enabled on \`${defaultBranch}\`\n`;
            summary += `- âœ… Migration manifest updated\n\n`;

            summary += '## ðŸ“‹ Next Steps\n\n';
            summary += `1. ðŸ”— Visit your migrated repository: https://github.com/${targetOrg}/${targetRepo}\n`;
            summary += `2. ðŸ” Verify repository contents and settings\n`;
            summary += `3. ðŸ”’ Review and adjust branch protection rules if needed\n`;
            summary += `4. ðŸ‘¥ Verify team access and collaborator permissions\n`;
            summary += `5. ðŸš€ Start developing!\n\n`;

            summary += '---\n\n';
            summary += `*GEI migration completed via workflow run #${runId}, completing issue #${issueNumber}*\n`;

            await core.summary
              .addRaw(summary)
              .write();

      - name: Post success comment to issue
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            const sourceOrg = '${{ needs.validate.outputs.source_organization }}';
            const sourceRepo = '${{ needs.validate.outputs.source_repo }}';
            const targetOrg = '${{ needs.validate.outputs.target_organization }}';
            const targetRepo = '${{ needs.validate.outputs.target_repo }}';
            const targetVisibility = '${{ needs.validate.outputs.target_visibility }}';
            const admins = '${{ needs.validate.outputs.admins }}';
            const migrationOptions = '${{ needs.validate.outputs.migration_options }}';
            const issueNumber = '${{ needs.validate.outputs.issue_number }}';
            const runId = context.runId;
            const runUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
            const sourceBranches = '${{ needs.pre-migration.outputs.source_branches }}';
            const sourceTags = '${{ needs.pre-migration.outputs.source_tags }}';
            const sourceHeadSha = '${{ needs.pre-migration.outputs.source_head_sha }}';
            const defaultBranch = '${{ needs.pre-migration.outputs.source_default_branch }}';
            const archiveSource = '${{ needs.pre-migration.outputs.archive_source }}';

            let adminsSection = '';
            if (admins) {
              const adminList = admins.split(',').map(a => a.trim().replace(/^@/, '')).filter(a => a);
              adminsSection = '\n\n### ðŸ‘¤ Admin Access\n';
              for (const admin of adminList) {
                adminsSection += `- \`${admin}\` â€” admin âœ…\n`;
              }
            }

            let optionsSection = '';
            if (migrationOptions) {
              const options = migrationOptions.split(',').map(o => o.trim()).filter(o => o);
              if (options.length > 0) {
                optionsSection = '\n\n### âš™ï¸ Migration Options Applied\n';
                for (const option of options) {
                  optionsSection += `- âœ… ${option}\n`;
                }
              }
            }

            const commentBody = `## âœ… GHEC Migration Completed Successfully!

            Your repository has been migrated from GitHub.com to GitHub.com via GEI.

            ### ðŸŽ‰ Migration Details
            - **Source Repository:** \`${sourceOrg}/${sourceRepo}\`
            - **Target Repository:** [${targetOrg}/${targetRepo}](https://github.com/${targetOrg}/${targetRepo})
            - **Target Visibility:** ${targetVisibility}
            - **Default Branch:** ${defaultBranch}
            - **Workflow Run:** [#${runId}](${runUrl})

            ### ðŸ“Š Verification Results
            | Check | Source | Target | Status |
            |-------|--------|--------|--------|
            | **Branches** | ${sourceBranches} | ${sourceBranches} | âœ… |
            | **Tags** | ${sourceTags} | ${sourceTags} | âœ… |
            | **HEAD SHA** | \`${sourceHeadSha.substring(0, 12)}\` | \`${sourceHeadSha.substring(0, 12)}\` | âœ… |

            ### ðŸ“¦ Post-Migration Actions
            - ${archiveSource === 'true' ? 'âœ…' : 'â­ï¸'} Source repository archived after migration
            - âœ… Branch protection enabled on \`${defaultBranch}\`
            - âœ… Migration manifest updated${adminsSection}${optionsSection}

            ### ðŸ“‹ Next Steps
            1. Visit your migrated repository: https://github.com/${targetOrg}/${targetRepo}
            2. Verify repository contents and settings
            3. Review and adjust branch protection rules if needed
            4. Verify team access and collaborator permissions
            5. Start developing! ðŸš€

            ---
            *Automated by GitHub Actions workflow â€” GEI migration applied successfully*`;

            await github.rest.issues.createComment({
              issue_number: parseInt(issueNumber),
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: commentBody
            });
      - name: Close issue
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = '${{ needs.validate.outputs.issue_number }}';
            const sourceOrg = '${{ needs.validate.outputs.source_organization }}';
            const sourceRepo = '${{ needs.validate.outputs.source_repo }}';
            const targetOrg = '${{ needs.validate.outputs.target_organization }}';
            const targetRepo = '${{ needs.validate.outputs.target_repo }}';
            const sourceBranches = '${{ needs.pre-migration.outputs.source_branches }}';
            const sourceTags = '${{ needs.pre-migration.outputs.source_tags }}';
            const sourceHeadSha = '${{ needs.pre-migration.outputs.source_head_sha }}';
            const archiveSource = '${{ needs.pre-migration.outputs.archive_source }}';
            const targetUrl = `https://github.com/${targetOrg}/${targetRepo}`;

            let archiveMsg = '';
            if (archiveSource === 'true') {
              archiveMsg = '\n- ðŸ“¦ Source repository archived on GitHub.com';
            }

            const commentBody = `### ðŸŽ‰ Migration Completed Successfully!

            | Detail | Value |
            |--------|-------|
            | **Source (GitHub.com)** | \`${sourceOrg}/${sourceRepo}\` |
            | **Target (GitHub.com)** | [\`${targetOrg}/${targetRepo}\`](${targetUrl}) |
            | **Branches** | ${sourceBranches} |
            | **Tags** | ${sourceTags} |
            | **HEAD SHA** | \`${sourceHeadSha}\` |
            | **Verification** | âœ… All checks passed |
            ${archiveMsg}

            The repository has been successfully migrated.`;

            // Post completion comment
            await github.rest.issues.createComment({
              issue_number: parseInt(issueNumber),
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: commentBody
            });

            // Close issue
            await github.rest.issues.update({
              issue_number: parseInt(issueNumber),
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'closed',
              state_reason: 'completed'
            });

            // Add completion label and remove in-progress
            try {
              await github.rest.issues.removeLabel({
                issue_number: parseInt(issueNumber),
                owner: context.repo.owner,
                repo: context.repo.repo,
                name: 'in-progress'
              });
            } catch (e) {
              // Label may not exist, ignore
            }

            await github.rest.issues.addLabels({
              issue_number: parseInt(issueNumber),
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: ['completed']
            });
